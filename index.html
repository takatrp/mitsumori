<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>æ¾æœ¬ä¼šè¨ˆï½œå ±é…¬è¦‹ç©ãƒ„ãƒ¼ãƒ« r4.3ï¼ˆä»•æ§˜æ›´æ–°ï¼‰</title>
<style>
:root{
  --mk-bg:#f7fafc; --mk-card:#fff; --mk-ink:#1a202c; --mk-sub:#4a5568;
  --mk-primary:#578899; --mk-border:#e2e8f0; --ok:#2f855a; --warn:#c05621;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--mk-bg);color:var(--mk-ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--mk-card),rgba(255,255,255,.92));border-bottom:1px solid var(--mk-border);backdrop-filter:saturate(1.2) blur(4px)}
.bar{display:flex;justify-content:space-between;align-items:center;gap:.6rem;max-width:1000px;margin:0 auto;padding:.75rem 1rem}
.title{font-weight:800}
.badge{background:var(--mk-primary);color:#fff;border-radius:999px;padding:.15rem .55rem;font-size:.75rem}
.container{max-width:1000px;margin:1rem auto;padding:0 .75rem 7rem}
.grid{display:grid;grid-template-columns:1fr;gap:1rem}
@media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
.card{background:var(--mk-card);border:1px solid var(--mk-border);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
.card .hd{display:flex;justify-content:space-between;align-items:center;padding:.8rem 1rem;border-bottom:1px dashed var(--mk-border)}
.card .bd{padding:1rem}
.btn{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--mk-border);background:#fff;border-radius:999px;padding:.45rem .8rem;font-weight:600;cursor:pointer}
.btn.sm{padding:.35rem .6rem;font-size:.85rem}
.btn.primary{background:var(--mk-primary);border-color:var(--mk-primary);color:#fff}
.btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.seg{display:flex;border:1px solid var(--mk-border);border-radius:10px;overflow:hidden}
.seg button{border:0;background:#fff;padding:.45rem .7rem;cursor:pointer}
.seg button.active{background:var(--mk-primary);color:#fff}
.mini{font-size:.85rem;color:var(--mk-sub)}
input[type="number"],input[type="text"]{width:100%;border:1px solid var(--mk-border);border-radius:10px;padding:.55rem .7rem;font-size:1rem;background:#fff}
input[type="number"]{text-align:right}
select{border:1px solid var(--mk-border);border-radius:10px;padding:.45rem .6rem;background:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:.5rem .35rem;border-bottom:1px solid var(--mk-border);text-align:right;font-variant-numeric:tabular-nums}
th:first-child,td:first-child{text-align:left}
tfoot td{font-weight:800}
.pill{font-size:.8rem;border:1px solid var(--mk-border);border-radius:999px;padding:.2rem .6rem;background:#fff}
.divider{height:1px;background:linear-gradient(to right,transparent,var(--mk-border),transparent);margin:.75rem 0}
.wrap{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
footer.mk-mini{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--mk-border);padding:.5rem .75rem;font-size:.8rem}
footer.mk-mini .inner{max-width:1000px;margin:0 auto;display:flex;gap:.6rem;flex-wrap:wrap}
footer.mk-mini a{color:inherit;text-decoration:underline}
summary{list-style:none;cursor:pointer}
summary::marker{display:none}
summary .caret{display:inline-block;transition:transform .2s}
.details[open] summary .caret{transform:rotate(90deg)}
.test-pass{color:#2f855a;font-weight:700}
.test-fail{color:#c05621;font-weight:700}
@media print{header,.noprint{display:none!important}.container{padding:0}.grid{grid-template-columns:1fr}body{background:#fff}.card{box-shadow:none;border:1px solid #bbb}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="wrap">
      <span class="title">å ±é…¬è¦‹ç©ãƒ„ãƒ¼ãƒ«</span>
      <span class="badge">r4.3ï¼ˆä»•æ§˜æ›´æ–°ï¼‰</span>
      <span class="mini">æ¾æœ¬ä¼šè¨ˆï½œã‚¹ãƒãƒ›å¯¾å¿œ</span>
    </div>
    <div class="wrap noprint">
      <!-- ä¸Šä½ï¼šæ³•äºº/å€‹äºº åˆ‡æ›¿ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã¯JSã§ä»˜ä¸ï¼‰ -->
      <div class="seg" aria-label="åŒºåˆ†åˆ‡æ›¿">
        <button id="ent-corp">æ³•äºº</button>
        <button id="ent-sole">å€‹äºº</button>
      </div>
      <button class="btn sm" onclick="window.print()">å°åˆ·/PDF</button>
      <button class="btn sm" onclick="localStorage.clear();location.reload()">åˆæœŸåŒ–</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid">
    <!-- å·¦ï¼šå…¥åŠ› -->
    <section class="card">
      <div class="hd">
        <strong>å…¥åŠ›ï¼ˆä»˜åŠ ä¾¡å€¤é¡â†’æœˆæ¬¡é¡§å•æ–™ï¼‰</strong>
        <div class="seg noprint">
          <button id="tab-v" class="active">ä»˜åŠ ä¾¡å€¤</button>
          <button id="tab-s">ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ</button>
        </div>
      </div>

      <!-- ä»˜åŠ ä¾¡å€¤å…¥åŠ› -->
      <div class="bd" id="pane-v">
        <div class="wrap">
          <span class="pill">åŒºåˆ†ï¼š<b id="ent-label">æ³•äºº</b></span>
        </div>
        <div class="divider"></div>

        <div id="calc-corp">
          <div class="mini">ç®—å¼ï¼ˆæ³•äººï¼‰ï¼š<b>çµŒå¸¸åˆ©ç›Šï¼‹äººä»¶è²»ï¼‹æ”¯æ‰•åˆ©æ¯ï¼‹è³ƒå€Ÿæ–™ï¼‹ãƒªãƒ¼ã‚¹æ–™ï¼‹ç§Ÿç¨å…¬èª²ï¼‹æ¸›ä¾¡å„Ÿå´è²»</b></div>
          <div class="divider"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem">
            <div><div class="mini">çµŒå¸¸åˆ©ç›Š</div><input id="c_ordinary" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">äººä»¶è²»</div><input id="c_labor" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">æ”¯æ‰•åˆ©æ¯</div><input id="c_int" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">è³ƒå€Ÿæ–™</div><input id="c_rent" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">ãƒªãƒ¼ã‚¹æ–™</div><input id="c_lease" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">ç§Ÿç¨å…¬èª²</div><input id="c_tax" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">æ¸›ä¾¡å„Ÿå´è²»</div><input id="c_dep" type="number" inputmode="numeric" oninput="recalc()"></div>
          </div>
        </div>

        <div id="calc-sole" style="display:none">
          <div class="mini">ç®—å¼ï¼ˆå€‹äººï¼‰ï¼š<b>é’è‰²æ§é™¤å‰åˆ©ç›Šï¼‹é’è‰²å°‚å¾“è€…çµ¦ä¸ï¼‹äººä»¶è²»ï¼‹æ”¯æ‰•åˆ©æ¯ï¼‹è³ƒå€Ÿæ–™ï¼‹ãƒªãƒ¼ã‚¹æ–™ï¼‹ç§Ÿç¨å…¬èª²ï¼‹æ¸›ä¾¡å„Ÿå´è²»ï¼‹3,000,000</b></div>
          <div class="divider"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem">
            <div><div class="mini">é’è‰²æ§é™¤å‰åˆ©ç›Š</div><input id="s_preprofit" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">é’è‰²å°‚å¾“è€…çµ¦ä¸</div><input id="s_family" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">äººä»¶è²»</div><input id="s_labor" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">æ”¯æ‰•åˆ©æ¯</div><input id="s_int" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">è³ƒå€Ÿæ–™</div><input id="s_rent" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">ãƒªãƒ¼ã‚¹æ–™</div><input id="s_lease" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">ç§Ÿç¨å…¬èª²</div><input id="s_tax" type="number" inputmode="numeric" oninput="recalc()"></div>
            <div><div class="mini">æ¸›ä¾¡å„Ÿå´è²»</div><input id="s_dep" type="number" inputmode="numeric" oninput="recalc()"></div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="wrap">
          <span class="pill">ä»˜åŠ ä¾¡å€¤é¡ï¼š<b id="vadd">0</b> å††/å¹´</span>
          <span class="pill">è©²å½“å¸¯ï¼š<b id="band">â€”</b></span>
          <span class="pill">æœˆæ¬¡é¡§å•æ–™ï¼ˆç¨æŠœï¼‰ï¼š<b id="monthly">Â¥0</b></span>
        </div>
        <div class="divider"></div>

        <!-- æŠ˜ã‚ŠãŸãŸã¿ï¼šä»˜åŠ ä¾¡å€¤å¸¯ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <details id="bandsWrap" class="details">
          <summary class="pill" style="display:inline-flex;align-items:center;gap:.5rem">
            <span class="caret">â–¶</span>
            <span>ä»˜åŠ ä¾¡å€¤å¸¯ãƒ¼æœˆæ¬¡é¡§å•æ–™ï¼ˆç¨æŠœï¼‰</span>
            <span class="mini">ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</span>
          </summary>
          <div style="margin-top:.5rem">
            <table id="bands">
              <thead><tr><th>ä»˜åŠ ä¾¡å€¤å¸¯</th><th>æœˆæ¬¡é¡§å•æ–™ï¼ˆç¨æŠœï¼‰</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>

      <!-- ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ -->
      <div class="bd" id="pane-s" style="display:none">
        <div class="mini">å¿…è¦ãªé …ç›®ã«ãƒã‚§ãƒƒã‚¯ï¼æ•°é‡å…¥åŠ›ï¼ˆä¸‹è¨˜ã®ä¸€éƒ¨ã¯ã€Œæœˆæ¬¡é¡§å•æ–™ã€ã‚’åŸºç¤ã«è‡ªå‹•ç®—å®šã—ã¾ã™ï¼‰ã€‚
          <span class="pill">åŒºåˆ†ï¼š<b id="ent-label2">æ³•äºº</b></span>
        </div>
        <div class="divider"></div>
        <div id="services"></div>
      </div>
    </section>

    <!-- å³ï¼šè¦‹ç© -->
    <section class="card">
      <div class="hd">
        <strong>è¦‹ç©ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</strong>
        <div class="wrap noprint">
          <button class="btn" id="copy-btn">å†…è¨³ã‚³ãƒ”ãƒ¼</button>
          <button class="btn" onclick="window.print()">å°åˆ·/PDF</button>
        </div>
      </div>
      <div class="bd">
        <table id="quote">
          <thead><tr><th>é …ç›®</th><th>åŒºåˆ†</th><th>æ•°é‡</th><th>å˜ä¾¡</th><th>å°è¨ˆ</th></tr></thead>
        <tbody id="q-body"></tbody>
          <tfoot>
            <tr><td colspan="4">æœˆé¡å°è¨ˆ</td><td id="sum-m">Â¥0</td></tr>
            <tr><td colspan="4">å¹´é¡å°è¨ˆï¼ˆ=æœˆé¡Ã—12ï¼‰</td><td id="sum-y">Â¥0</td></tr>
            <tr><td colspan="4">ã‚¹ãƒãƒƒãƒˆ</td><td id="sum-o">Â¥0</td></tr>
            <tr>
              <td colspan="3" style="text-align:left">
                <div class="mini">èª¿æ•´ï¼ˆè‡ªç”±è¨˜å…¥ãƒ¡ãƒ¢ï¼‰</div>
                <input id="adj-memo" type="text" placeholder="ä¾‹ï¼šå€¤å¼•ããƒ»ç«¯æ•°èª¿æ•´ãªã©">
              </td>
              <td style="text-align:left">èª¿æ•´é¡ï¼ˆÂ±ï¼‰</td>
              <td><input id="adj-amt" type="number" step="100" value="0" style="width:130px;text-align:right"></td>
            </tr>
            <tr><td colspan="4">æ¶ˆè²»ç¨</td><td id="sum-tax">Â¥0</td></tr>
            <tr><td colspan="4">åˆè¨ˆ</td><td id="sum-t" style="font-weight:800">Â¥0</td></tr>
          </tfoot>
        </table>
        <div class="mini" style="margin-top:.5rem">â€» å­¦æ ¡æ³•äººãƒ»ç¤¾ç¦ãƒ»å®—æ•™ãƒ»NPOãƒ»å…¬ç›Šç­‰ã¯<b>åˆ¥é€”å¾¡è¦‹ç©ã‚Š</b>æ‰±ã„ã€‚</div>
      </div>
    </section>
  </div>

  <!-- ãƒ†ã‚¹ãƒˆç”¨ï¼šç°¡æ˜“ãƒãƒ¼ãƒã‚¹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å®Ÿè¡Œï¼‰ -->
  <details class="card" style="margin-top:1rem">
    <summary class="hd" style="cursor:pointer"><strong>ğŸ”§ é–‹ç™ºè€…å‘ã‘ãƒ†ã‚¹ãƒˆï¼ˆr4.3ï¼‰</strong><span class="mini">ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹</span></summary>
    <div class="bd">
      <button class="btn ok" id="run-tests">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
      <ul id="test-log" class="mini" style="margin-top:.5rem"></ul>
    </div>
  </details>
</div>

<footer class="mk-mini">
  <div class="inner">
    Â© <span id="cpy-year"></span> <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener">ç¨ç†å£«æ³•äººæ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€</a> ï½œ
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ja" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> ï½œ
    <a href="#" onclick="alert('æœ¬ãƒ„ãƒ¼ãƒ«ã¯æ¦‚ç®—è¦‹ç©ã®è£œåŠ©ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚æœ€çµ‚å ±é…¬é¡ã¯å€‹åˆ¥å¥‘ç´„ãƒ»æ¥­å‹™ç¯„å›²ãƒ»ç¹å¿™åº¦ãƒ»ãƒ‡ãƒ¼ã‚¿å“è³ªç­‰ã«ã‚ˆã‚Šèª¿æ•´ã—ã¾ã™ã€‚');return false;">åˆ©ç”¨æ¡ä»¶</a> ï½œ
    <span id="rev"></span>
  </div>
</footer>

<script>
const APP_VER = 'r4.3';
const el=(id)=>document.getElementById(id);
const fmt=(n)=> (isNaN(n)?0:n).toLocaleString('ja-JP');
const yen=(n)=>'Â¥'+fmt(Math.round(n||0));
const TAX=0.10;

// åŒºåˆ†ï¼ˆæ³•äºº/å€‹äººï¼‰
let ent = localStorage.getItem('mk_ent')||'corp';

// å¸¯ãƒ†ãƒ¼ãƒ–ãƒ«
const bandsCorp=[
  {min:0, max:5000000, fee:35000},
  {min:5000000, max:10000000, fee:37000},
  {min:10000000, max:20000000, fee:39000},
  {min:20000000, max:30000000, fee:41000},
  {min:30000000, max:50000000, fee:45000},
  {min:50000000, max:70000000, fee:49000},
  {min:70000000, max:100000000, fee:55000},
  {min:100000000, max:200000000, fee:73000},
  {min:200000000, max:300000000, fee:89000},
  {min:300000000, max:500000000, fee:105000},
  {min:500000000, max:700000000, fee:119000},
  {min:700000000, max:1000000000, fee:125000},
  {min:1000000000, max:2000000000, fee:143000},
  {min:2000000000, max:3000000000, fee:170000},
  {min:3000000000, max:5000000000, fee:215000},
  {min:5000000000, max:10000000000, fee:260000},
  {min:10000000000, max:Infinity, fee:null}
];
const bandsSole=[
  {min:0, max:5000000, fee:27000},
  {min:5000000, max:10000000, fee:29000},
  {min:10000000, max:20000000, fee:31000},
  {min:20000000, max:30000000, fee:33000},
  {min:30000000, max:50000000, fee:37000},
  {min:50000000, max:70000000, fee:41000},
  {min:70000000, max:100000000, fee:47000},
  {min:100000000, max:Infinity, fee:null}
];

// ãƒã‚¹ã‚¿ï¼šã‚µãƒ¼ãƒ“ã‚¹ï¼ˆent: 'corp'|'sole'|'both'ï¼‰
// kind: fixed|mult_m|per_qty|group_other|asset_tax
// editablePrice: true ã§å˜ä¾¡ã®ç·¨é›†UIã‚’å‡ºã™
const servicesMaster=[
  {ent:'both',cat:"æœˆæ¬¡é¡§å•", name:"æœˆæ¬¡é¡§å•æ–™ï¼ˆä»˜åŠ ä¾¡å€¤ãƒ™ãƒ¼ã‚¹ï¼‰", unit:"æœˆé¡", kind:"fixed", price:0, qty:1, allowQty:false, note:"ä»˜åŠ ä¾¡å€¤å¸¯ã‹ã‚‰è‡ªå‹•è¨­å®š"},

  {ent:'corp',cat:"æ±ºç®—ãƒ»ç”³å‘Šï¼ˆæ³•äººï¼‰", name:"æ³•äººæ±ºç®—ãƒ»ç”³å‘Šä¸€å¼", unit:"ã‚¹ãƒãƒƒãƒˆ", kind:"mult_m", months:4, price:0, qty:0, allowQty:false, note:"æœˆæ¬¡é¡§å•å ±é…¬ã®4ãƒ¶æœˆåˆ†"},
  {ent:'corp',cat:"æ±ºç®—ãƒ»ç”³å‘Šï¼ˆæ³•äººï¼‰", name:"æ¶ˆè²»ç¨ç”³å‘Šæ›¸ä½œæˆ", unit:"ã‚¹ãƒãƒƒãƒˆ", kind:"mult_m", months:2, price:0, qty:0, allowQty:false, note:"æœˆæ¬¡é¡§å•å ±é…¬ã®2ãƒ¶æœˆåˆ†"},

  {ent:'both',cat:"å¹´æœ«èª¿æ•´", name:"å¹´æœ«èª¿æ•´ åŸºæœ¬æ–™é‡‘", unit:"ã‚¹ãƒãƒƒãƒˆ", kind:"fixed", price:20000, qty:0, allowQty:false, note:"æ³•å®šèª¿æ›¸åˆè¨ˆè¡¨å«ã‚€"},
  {ent:'both',cat:"å¹´æœ«èª¿æ•´", name:"å¹´æœ«èª¿æ•´ äººæ•°ï¼ˆ1äººç›®ã‹ã‚‰ï¼‰", unit:"ã‚¹ãƒãƒƒãƒˆ", kind:"per_qty", price:3000, qty:0, allowQty:true, note:"Ã—äººæ•°"},

  {ent:'both',cat:"å„Ÿå´è³‡ç”£ç¨ç”³å‘Š", name:"å„Ÿå´è³‡ç”£ç¨ç”³å‘Šï¼ˆå¸‚ç”ºæ‘ãƒ»ä»¶æ•°ï¼‰", unit:"ã‚¹ãƒãƒƒãƒˆ", kind:"asset_tax", base:10000, extra:3000, qty:0, allowQty:true, note:"åŸºæœ¬10,000å††ï¼‹ï¼ˆä»¶æ•°-1ï¼‰Ã—3,000å††"},

  {ent:'both',cat:"ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«", name:"FX4ã‚¯ãƒ©ã‚¦ãƒ‰", unit:"æœˆé¡", kind:"fixed", price:60000, qty:0, allowQty:false, editablePrice:true},
  {ent:'both',cat:"ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«", name:"FX2ã‚¯ãƒ©ã‚¦ãƒ‰", unit:"æœˆé¡", kind:"fixed", price:15000, qty:0, allowQty:false, editablePrice:true},
  {ent:'both',cat:"ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«", name:"FXã¾ã„ã‚¹ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¦ãƒ‰", unit:"æœˆé¡", kind:"fixed", price:12000, qty:0, allowQty:false, editablePrice:true},
  {ent:'both',cat:"ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«", name:"ï¼ˆãã®ä»–ï¼‰", unit:"æœˆé¡", kind:"group_other", price:0, qty:0, allowQty:false, note:"ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹"},
  {ent:'both',cat:"ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«", name:"PX4ã‚¯ãƒ©ã‚¦ãƒ‰", unit:"æœˆé¡", kind:"fixed", price:0, qty:0, allowQty:false, editablePrice:true, swOther:true}
];

// å®Ÿåƒé…åˆ—ï¼ˆåŒºåˆ†åˆ¥ã«ãƒ­ãƒ¼ãƒ‰ï¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³å·®ã—æ›¿ãˆï¼‰
let services = [];
function resetServices(){
  services = servicesMaster.filter(s=> s.ent==='both' || s.ent===ent).map(s=>({...s}));
}
function loadServices(){
  const key = `mk_services_${ent}`;
  const ver = localStorage.getItem('mk_ver');
  if(ver!==APP_VER){ localStorage.removeItem(`mk_services_corp`); localStorage.removeItem(`mk_services_sole`); localStorage.setItem('mk_ver', APP_VER); }
  try{
    const saved = JSON.parse(localStorage.getItem(key)||'null');
    if(saved && Array.isArray(saved)) { services = saved; return; }
  }catch(e){}
  resetServices();
}

function persist(){ localStorage.setItem(`mk_services_${ent}`, JSON.stringify(services)); }

// èª¿æ•´ï¼ˆè‡ªç”±è¨˜å…¥ï¼‰
let adjust = { memo: localStorage.getItem('mk_adj_memo')||'', amt: parseFloat(localStorage.getItem('mk_adj_amt')||'0') };

function setEnt(v){
  persist();
  ent=v; localStorage.setItem('mk_ent', ent);
  // UIåˆ‡æ›¿
  document.getElementById('ent-corp').classList.toggle('active', ent==='corp');
  document.getElementById('ent-sole').classList.toggle('active', ent==='sole');
  el('ent-label').textContent = ent==='corp'?'æ³•äºº':'å€‹äºº';
  el('ent-label2').textContent = ent==='corp'?'æ³•äºº':'å€‹äºº';
  // ã‚µãƒ¼ãƒ“ã‚¹å†ãƒ­ãƒ¼ãƒ‰
  loadServices();
  renderBands();
  recalc();
}
// å¿µã®ãŸã‚ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
window.setEnt = setEnt;

function renderBands(){
  const tbody = el('bands').querySelector('tbody'); tbody.innerHTML='';
  const b = (ent==='corp'?bandsCorp:bandsSole);
  b.forEach(x=>{
    const tr=document.createElement('tr');
    const label = x.max===Infinity ? `${fmt(x.min)}å††è¶…` : `${fmt(x.min)}ã€œ${fmt(x.max)}å††`;
    tr.innerHTML = `<td>${label}</td><td>${x.fee?yen(x.fee):'åˆ¥é€”ãŠè¦‹ç©ã‚Š'}</td>`;
    tbody.appendChild(tr);
  });
}

function calcVadd(){
  if(ent==='corp'){
    const p=+el('c_ordinary').value||0;
    const labor=+el('c_labor').value||0;
    const i=+el('c_int').value||0;
    const r=+el('c_rent').value||0;
    const l=+el('c_lease').value||0;
    const t=+el('c_tax').value||0;
    const d=+el('c_dep').value||0;
    return Math.max(0,p+labor+i+r+l+t+d);
  }else{
    const pre=+el('s_preprofit').value||0;
    const fam=+el('s_family').value||0;
    const labor=+el('s_labor').value||0;
    const i=+el('s_int').value||0;
    const r=+el('s_rent').value||0;
    const l=+el('s_lease').value||0;
    const t=+el('s_tax').value||0;
    const d=+el('s_dep').value||0;
    return Math.max(0, pre+fam+labor+i+r+l+t+d+3000000);
  }
}

function bandFee(v){
  const arr = (ent==='corp'?bandsCorp:bandsSole);
  for(const x of arr){ if(v>=x.min && v<x.max){ return x.fee; } }
  return null;
}

function recalc(){
  const corp = ent==='corp';
  el('calc-corp').style.display = corp?'block':'none';
  el('calc-sole').style.display = corp?'none':'block';

  const v = calcVadd();
  el('vadd').textContent = fmt(v);
  const fee = bandFee(v);
  const monthly = fee? fee : 0;
  el('monthly').textContent = yen(monthly);
  const arr = (ent==='corp'?bandsCorp:bandsSole);
  const band = arr.find(x=>v>=x.min && v<x.max);
  el('band').textContent = band ? (band.max===Infinity?`${fmt(band.min)}å††è¶…`:`${fmt(band.min)}ã€œ${fmt(band.max)}å††`) : 'â€”';

  if(services.length && services[0].cat==='æœˆæ¬¡é¡§å•') services[0].price = monthly;
  renderServices();
  renderQuote();
  persist();
}

function renderServices(){
  const host = el('services'); host.innerHTML='';
  // è¡¨ç¤ºé †ï¼ˆæ³•äººã§ã¯ã€Œã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«ã€ã‚’æœˆæ¬¡ã®ç›´ä¸‹ï¼‰
  const orderCorp = ["æœˆæ¬¡é¡§å•","ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«","æ±ºç®—ãƒ»ç”³å‘Šï¼ˆæ³•äººï¼‰","å¹´æœ«èª¿æ•´","å„Ÿå´è³‡ç”£ç¨ç”³å‘Š","å€‹äººç¢ºå®šç”³å‘Š"];
  const orderSole = ["æœˆæ¬¡é¡§å•","ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«","å€‹äººç¢ºå®šç”³å‘Š","å¹´æœ«èª¿æ•´","å„Ÿå´è³‡ç”£ç¨ç”³å‘Š","æ±ºç®—ãƒ»ç”³å‘Šï¼ˆæ³•äººï¼‰"];
  const order = ent==='corp'?orderCorp:orderSole;

  const cats = [...new Set(services.map(x=>x.cat))].sort((a,b)=> order.indexOf(a)-order.indexOf(b));

  cats.forEach(c=>{
    const items = services.filter(x=>x.cat===c);
    if(!items.length) return;
    const box=document.createElement('div'); box.className='card'; box.style.marginBottom='.6rem';
    box.innerHTML = `<div class=\"hd\"><strong>${c}</strong><span class=\"mini\">${items.length}é …ç›®</span></div>`;
    const bd=document.createElement('div'); bd.className='bd';

    // ç‰¹åˆ¥ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼šã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«
    if(c==='ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«'){
      const primaries = items.filter(x=>!x.swOther && x.kind!=='group_other');
      const others = items.filter(x=>x.swOther);
      // ä¸¦ã³ï¼šFX4â†’FX2â†’FXã¾ã„ã‚¹ã‚¿ãƒ¼
      const orderNames = ['FX4ã‚¯ãƒ©ã‚¦ãƒ‰','FX2ã‚¯ãƒ©ã‚¦ãƒ‰','FXã¾ã„ã‚¹ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¦ãƒ‰'];
      primaries.sort((a,b)=> orderNames.indexOf(a.name)-orderNames.indexOf(b.name));

      primaries.forEach(it=> bd.appendChild(renderServiceRow(it)));

      // ãã®ä»–ã‚°ãƒ«ãƒ¼ãƒ—
      const grp = items.find(x=>x.kind==='group_other');
      if(grp){
        const det = document.createElement('details'); det.className='details';
        const sum = document.createElement('summary'); sum.className='pill'; sum.style.display='inline-flex'; sum.style.alignItems='center'; sum.style.gap='.5rem';
        sum.innerHTML = `<span class=\"caret\">â–¶</span><span>ãã®ä»–</span><span class=\"mini\">ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</span>`;
        det.appendChild(sum);
        const inner=document.createElement('div'); inner.style.marginTop='.5rem';
        others.forEach(it=> inner.appendChild(renderServiceRow(it)));
        // è‡ªç”±å…¥åŠ›ã®è¿½åŠ UI
        const addBox=document.createElement('div'); addBox.className='wrap'; addBox.style.marginTop='.5rem';
        addBox.innerHTML = `
          <input id=\"custom-soft-name\" type=\"text\" placeholder=\"ã‚½ãƒ•ãƒˆåï¼ˆä¾‹ï¼šXXXã‚¯ãƒ©ã‚¦ãƒ‰ï¼‰\" style=\"max-width:220px\">
          <input id=\"custom-soft-price\" type=\"number\" min=\"0\" step=\"100\" placeholder=\"æœˆé¡å˜ä¾¡\" style=\"max-width:150px\">
          <button class=\"btn sm\" type=\"button\" onclick=\"addCustomSoft()\">è¿½åŠ </button>
          <span class=\"mini\">â€» è¿½åŠ ã™ã‚‹ã¨ä¸‹ã®ä¸€è¦§ã«ç¾ã‚Œã¾ã™</span>`;
        inner.appendChild(addBox);
        det.appendChild(inner); bd.appendChild(det);
      }

      box.appendChild(bd); host.appendChild(box); return;
    }

    // é€šå¸¸ã‚«ãƒ†ã‚´ãƒª
    items.forEach(it=> bd.appendChild(renderServiceRow(it)));
    box.appendChild(bd); host.appendChild(box);
  });
}

function renderServiceRow(it){
  const idx = services.indexOf(it);
  const id = `svc_${it.cat}_${idx}`;
  const row=document.createElement('div'); row.className='wrap'; row.style.justifyContent='space-between';
  const left=document.createElement('div'); left.style.flex='1';
  left.innerHTML = `<label for="${id}" style="display:block">${it.name} <span class="mini">(${it.unit})</span></label><div class="mini">${it.note||''}</div>`;
  const right=document.createElement('div'); right.className='wrap';

  let priceCtrl = `<span class="pill">å˜ä¾¡ <b>${it.kind==='mult_m' ? 'ï¼æœˆæ¬¡Ã—'+it.months : yen(it.price)}</b></span>`;
  if(it.kind==='asset_tax'){
    priceCtrl = `<span class=\"pill\">å˜ä¾¡ <b>${yen(it.base)}ï¼‹${yen(it.extra)}Ã—(ä»¶æ•°-1)</b></span>`;
  }
  if(it.editablePrice){
    priceCtrl = `<span class="pill">å˜ä¾¡ <input type="number" min="0" step="100" value="${it.price||0}" style="width:120px" oninput="setPrice(${idx}, this.value)"></span>`;
  }

  right.innerHTML = `
    ${it.allowQty?`<input id="${id}_qty" type="number" min="0" step="1" value="${it.qty||0}" style="width:110px" oninput="setQty(${idx}, this.value)">`:`<span class="pill">${it.qty>0?'é¸æŠä¸­':'æ•°é‡å›ºå®š'}</span>`}
    ${priceCtrl}
    ${it.kind!=='group_other'?`<input id="${id}" type="checkbox" ${it.qty>0?'checked':''} onchange="toggle(${idx}, this.checked)">`:''}
  `;
  row.appendChild(left); row.appendChild(right);
  return row;
}

function toggle(i, on){
  const it = services[i];
  if(it.allowQty){ it.qty = on ? (it.qty||1) : 0; }
  else{ it.qty = on ? 1 : 0; }
  renderQuote(); persist();
}
function setQty(i, v){
  const n = Math.max(0, parseFloat(v||0));
  services[i].qty = isNaN(n)?0:n;
  renderQuote(); persist();
}
function setPrice(i, v){
  const n = Math.max(0, parseFloat(v||0));
  services[i].price = isNaN(n)?0:n;
  renderQuote(); persist();
}

function renderQuote(){
  const body = el('q-body'); body.innerHTML='';
  let m=0,o=0;
  services.forEach(it=>{
    const q = +it.qty||0; if(!q || it.kind==='group_other') return;
    let unitPrice = 0, lineSub = 0;
    if(it.kind==='mult_m'){
      unitPrice = (services[0].price||0)*it.months; lineSub = unitPrice * q;
    }else if(it.kind==='per_qty'){
      unitPrice = (it.price||0)*q; lineSub = unitPrice;
    }else if(it.kind==='asset_tax'){
      // åŸºæœ¬10,000 + (ä»¶æ•°-1)*3,000ï¼ˆä»¶æ•°>=1ã§æˆç«‹ï¼‰
      lineSub = q>=1 ? (it.base + Math.max(0, q-1)*it.extra) : 0;
    }else{
      unitPrice = it.price||0; lineSub = unitPrice * q;
    }

    const unitDisp = (it.kind==='mult_m') ? ('æœˆæ¬¡Ã—'+it.months) : (it.kind==='asset_tax' ? `${yen(it.base)}ï¼‹${yen(it.extra)}Ã—(ä»¶æ•°-1)` : yen(it.price));

    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${it.name}</td><td>${it.unit}</td><td>${fmt(q)}</td><td>${unitDisp}</td><td>${yen(lineSub)}</td>`;
    body.appendChild(tr);

    if(it.unit==='æœˆé¡'){ m += lineSub; } else { o += lineSub; }
  });
  const y = m*12;
  const base = (m+y+o) + (adjust.amt||0);
  const tax = Math.round(base*TAX);
  const total = base + tax;

  el('sum-m').textContent=yen(m);
  el('sum-y').textContent=yen(y);
  el('sum-o').textContent=yen(o);
  el('sum-tax').textContent=yen(tax);
  el('sum-t').textContent=yen(total);
}

function copySummary(){
  const lines=['ã€è¦‹ç©å†…è¨³ã€‘'];
  services.forEach(it=>{
    const q=+it.qty||0; if(!q || it.kind==='group_other') return;
    const descr = it.kind==='mult_m' ? `(æœˆæ¬¡Ã—${it.months})` : (it.kind==='asset_tax' ? `(åŸºæœ¬${yen(it.base)}ï¼‹${yen(it.extra)}Ã—(ä»¶æ•°-1))` : '');
    let sub=0;
    if(it.kind==='mult_m'){ sub = (services[0].price||0)*it.months*q; }
    else if(it.kind==='per_qty'){ sub = (it.price||0)*q; }
    else if(it.kind==='asset_tax'){ sub = q>=1 ? (it.base + Math.max(0, q-1)*it.extra) : 0; }
    else{ sub = (it.price||0)*q; }
    lines.push(`ãƒ»${it.name}ï¼ˆ${it.unit}ï¼‰${descr}ï¼šæ•°é‡${q} Ã— ${it.kind==='mult_m'?'æœˆæ¬¡Ã—'+it.months:(it.kind==='asset_tax'?`${yen(it.base)}ï¼‹${yen(it.extra)}Ã—(ä»¶æ•°-1)`:yen(it.price))} = ${yen(sub)}`);
  });
  if((adjust.amt||0)!==0){
    lines.push(`èª¿æ•´ï¼š${yen(adjust.amt)}ï¼ˆ${(adjust.memo||'').trim()||'â€”'}ï¼‰`);
  }
  lines.push(`æœˆé¡å°è¨ˆï¼š${el('sum-m').textContent}`);
  lines.push(`å¹´é¡å°è¨ˆï¼š${el('sum-y').textContent}`);
  lines.push(`ã‚¹ãƒãƒƒãƒˆï¼š${el('sum-o').textContent}`);
  lines.push(`æ¶ˆè²»ç¨ï¼š${el('sum-tax').textContent}`);
  lines.push(`åˆè¨ˆï¼š${el('sum-t').textContent}`);
  navigator.clipboard.writeText(lines.join('\n')).then(()=>alert('å†…è¨³ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚'));
}

function switchTab(k){
  el('pane-v').style.display = k==='v'?'block':'none';
  el('pane-s').style.display = k==='s'?'block':'none';
  el('tab-v').classList.toggle('active', k==='v');
  el('tab-s').classList.toggle('active', k==='s');
}

function addCustomSoft(){
  const name = (document.getElementById('custom-soft-name').value||'').trim();
  const price = parseFloat(document.getElementById('custom-soft-price').value||'0');
  if(!name || price<=0){ alert('åç§°ã¨æœˆé¡å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  services.push({ent:'both',cat:'ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«',name,unit:'æœˆé¡',kind:'fixed',price,qty:0,allowQty:false,editablePrice:true,swOther:true});
  persist(); renderServices();
  document.getElementById('custom-soft-name').value='';
  document.getElementById('custom-soft-price').value='';
}

function logTest(ok,msg){
  const li=document.createElement('li');
  li.className= ok? 'test-pass':'test-fail';
  li.textContent = (ok?'âœ” ':'âœ– ')+msg;
  el('test-log').appendChild(li);
}
function clearTests(){ el('test-log').innerHTML=''; }

// åˆæœŸåŒ–
(function init(){
  const d=new Date(document.lastModified);
  el('cpy-year').textContent=String(new Date().getFullYear());
  el('rev').textContent=APP_VER+'ï¼ˆ'+d.toISOString().slice(0,10)+'ï¼‰';

  // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('ent-corp').addEventListener('click', ()=>setEnt('corp'));
  document.getElementById('ent-sole').addEventListener('click', ()=>setEnt('sole'));
  document.getElementById('tab-v').addEventListener('click', ()=>switchTab('v'));
  document.getElementById('tab-s').addEventListener('click', ()=>switchTab('s'));
  document.getElementById('copy-btn').addEventListener('click', copySummary);

  // èª¿æ•´å…¥åŠ›ã®å¾©å…ƒï¼†ã‚¤ãƒ™ãƒ³ãƒˆ
  el('adj-memo').value = adjust.memo||'';
  el('adj-amt').value = isNaN(adjust.amt)?0:adjust.amt;
  el('adj-memo').addEventListener('input', (e)=>{ adjust.memo=e.target.value||''; localStorage.setItem('mk_adj_memo', adjust.memo); });
  el('adj-amt').addEventListener('input', (e)=>{ adjust.amt=parseFloat(e.target.value||'0')||0; localStorage.setItem('mk_adj_amt', String(adjust.amt)); renderQuote(); });

  // åˆæœŸUI
  document.getElementById('ent-corp').classList.toggle('active', ent==='corp');
  document.getElementById('ent-sole').classList.toggle('active', ent==='sole');
  el('ent-label').textContent = ent==='corp'?'æ³•äºº':'å€‹äºº';
  el('ent-label2').textContent = ent==='corp'?'æ³•äºº':'å€‹äºº';

  loadServices();
  renderBands();
  recalc();

  // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒœã‚¿ãƒ³
  document.getElementById('run-tests').addEventListener('click', ()=>{
    clearTests();
    try{
      // 1) setEntã®å­˜åœ¨
      logTest(typeof window.setEnt==='function', 'window.setEnt ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹');

      // 2) ã‚«ãƒ†ã‚´ãƒªé †ï¼šã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«ãŒ2ç•ªç›®
      renderServices();
      const cats=[...document.querySelectorAll('#services .card .hd strong')].map(n=>n.textContent);
      logTest(cats[0]==='æœˆæ¬¡é¡§å•', 'ã‚«ãƒ†ã‚´ãƒª1=æœˆæ¬¡é¡§å•');
      logTest(cats[1]==='ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«', 'ã‚«ãƒ†ã‚´ãƒª2=ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ãƒ³ã‚¿ãƒ«');

      // 3) ãƒ—ãƒªã‚»ãƒƒãƒˆå˜ä¾¡
      const fx4 = services.find(s=>s.name==='FX4ã‚¯ãƒ©ã‚¦ãƒ‰');
      const fxm = services.find(s=>s.name==='FXã¾ã„ã‚¹ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¦ãƒ‰');
      logTest(fx4 && fx4.price===60000, 'FX4ã‚¯ãƒ©ã‚¦ãƒ‰ å˜ä¾¡=60,000');
      logTest(fxm && fxm.price===12000, 'FXã¾ã„ã‚¹ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¦ãƒ‰ å˜ä¾¡=12,000');

      // 4) å„Ÿå´è³‡ç”£ç¨ç”³å‘Šï¼šæ•°é‡1â†’10,000 / æ•°é‡3â†’16,000
      const idxA = services.findIndex(s=>s.kind==='asset_tax');
      services[idxA].qty=1; renderQuote();
      const spot1 = parseInt(document.getElementById('sum-o').textContent.replace(/[^0-9]/g,''),10);
      logTest(spot1>=10000, 'å„Ÿå´è³‡ç”£ç¨ç”³å‘Šï¼ˆ1ä»¶ï¼‰>=10,000ï¼ˆä»–ã®ã‚¹ãƒãƒƒãƒˆãŒ0ã§ã‚ã‚‹å‰æã§10,000ï¼‰');
      services[idxA].qty=3; renderQuote();
      const rows=[...document.querySelectorAll('#quote tbody tr')];
      const assetRow = rows.find(r=>r.children[0].textContent.includes('å„Ÿå´è³‡ç”£ç¨ç”³å‘Š'));
      const subTxt = assetRow ? assetRow.children[4].textContent.replace(/[^0-9]/g,'') : '0';
      logTest(subTxt==='16000', 'å„Ÿå´è³‡ç”£ç¨ç”³å‘Šï¼ˆ3ä»¶ï¼‰=16,000');

      // 5) èª¿æ•´ï¼ˆè‡ªç”±è¨˜å…¥ï¼‰ã«è² å€¤ã‚’å…¥ã‚Œã¦åˆè¨ˆãŒæ¸›ã‚‹
      document.getElementById('adj-amt').value = -5000; adjust.amt=-5000; renderQuote();
      const totalAfter = parseInt(document.getElementById('sum-t').textContent.replace(/[^0-9]/g,''),10);
      document.getElementById('adj-amt').value = 0; adjust.amt=0; renderQuote();
      const totalBefore = parseInt(document.getElementById('sum-t').textContent.replace(/[^0-9]/g,''),10);
      logTest(totalAfter < totalBefore, 'èª¿æ•´ï¼ˆ-5,000ï¼‰ã§åˆè¨ˆãŒæ¸›å°‘');

      // 6) ç¨æŠœ/ç¨è¾¼ãƒˆã‚°ãƒ«ãŒå­˜åœ¨ã—ãªã„
      const hasTaxToggle = document.getElementById('tax-ex') || document.getElementById('tax-in');
      logTest(!hasTaxToggle, 'ç¨æŠœ/ç¨è¾¼ãƒˆã‚°ãƒ«ã‚’å‰Šé™¤');
    }catch(e){
      logTest(false, 'ãƒ†ã‚¹ãƒˆã§ä¾‹å¤–: '+(e&&e.message));
    }
  });
})();
</script>
</body>
</html>
