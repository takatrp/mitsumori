<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>松本会計｜報酬見積ツール r4.4（UI更新）</title>
<style>
:root{
  --mk-bg:#f7fafc; --mk-card:#fff; --mk-ink:#1a202c; --mk-sub:#4a5568;
  --mk-primary:#578899; --mk-border:#e2e8f0; --ok:#2f855a; --warn:#c05621;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--mk-bg);color:var(--mk-ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--mk-card),rgba(255,255,255,.92));border-bottom:1px solid var(--mk-border);backdrop-filter:saturate(1.2) blur(4px)}
.bar{display:flex;justify-content:space-between;align-items:center;gap:.6rem;max-width:1100px;margin:0 auto;padding:.75rem 1rem}
.title{font-weight:800}
.badge{background:var(--mk-primary);color:#fff;border-radius:999px;padding:.15rem .55rem;font-size:.75rem}
.container{max-width:1100px;margin:1rem auto;padding:0 .75rem 7rem}
.grid{display:grid;grid-template-columns:1fr;gap:1rem}
@media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
.card{background:var(--mk-card);border:1px solid var(--mk-border);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
.card .hd{display:flex;justify-content:space-between;align-items:center;padding:.8rem 1rem;border-bottom:1px dashed var(--mk-border)}
.card .bd{padding:1rem}
.btn{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--mk-border);background:#fff;border-radius:999px;padding:.45rem .8rem;font-weight:600;cursor:pointer}
.btn.sm{padding:.35rem .6rem;font-size:.85rem}
.btn.primary{background:var(--mk-primary);border-color:var(--mk-primary);color:#fff}
.btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.seg{display:flex;border:1px solid var(--mk-border);border-radius:10px;overflow:hidden}
.seg button{border:0;background:#fff;padding:.45rem .7rem;cursor:pointer}
.seg button.active{background:var(--mk-primary);color:#fff}
.mini{font-size:.85rem;color:var(--mk-sub)}
input[type="text"],input[type="date"]{width:100%;border:1px solid var(--mk-border);border-radius:10px;padding:.55rem .7rem;font-size:1rem;background:#fff}
input[data-commas]{text-align:right}
select{border:1px solid var(--mk-border);border-radius:10px;padding:.45rem .6rem;background:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:.5rem .35rem;border-bottom:1px solid var(--mk-border);text-align:right;font-variant-numeric:tabular-nums}
th:first-child,td:first-child{text-align:left}
tfoot td{font-weight:800}
.pill{font-size:.8rem;border:1px solid var(--mk-border);border-radius:999px;padding:.2rem .6rem;background:#fff}
.divider{height:1px;background:linear-gradient(to right,transparent,var(--mk-border),transparent);margin:.75rem 0}
.wrap{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
footer.mk-mini{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--mk-border);padding:.5rem .75rem;font-size:.8rem}
footer.mk-mini .inner{max-width:1100px;margin:0 auto;display:flex;gap:.6rem;flex-wrap:wrap}
footer.mk-mini a{color:inherit;text-decoration:underline}
summary{list-style:none;cursor:pointer}
summary::marker{display:none}
summary .caret{display:inline-block;transition:transform .2s}
.details[open] summary .caret{transform:rotate(90deg)}
.test-pass{color:#2f855a;font-weight:700}
.test-fail{color:#c05621;font-weight:700}
.quote-section{display:none}
.print-header{display:none}
@media print{
  header,.noprint,.container .grid > :not(.quote-section), footer.mk-mini{display:none!important}
  body{background:#fff}
  .quote-section{display:block!important;border:none;box-shadow:none}
  .quote-section .hd{border:none}
  .print-header{display:block; padding:0 0 1rem 0; margin:0 0 1rem 0; border-bottom:2px solid #000}
  .print-header h1{margin:.2rem 0 0 0;font-size:1.6rem}
  .print-meta{display:flex;justify-content:space-between;align-items:flex-end}
  .print-meta .to{font-size:1rem}
  .print-meta .date{font-size:1rem}
}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="wrap">
      <span class="title">報酬見積ツール</span>
      <span class="badge">r4.4（UI更新）</span>
      <span class="mini">松本会計｜スマホ対応</span>
    </div>
    <div class="wrap noprint">
      <!-- 上位：法人/個人 切替（イベントはJSで付与） -->
      <div class="seg" aria-label="区分切替">
        <button id="ent-corp">法人</button>
        <button id="ent-sole">個人</button>
      </div>
      <button class="btn sm" onclick="window.print()">印刷/PDF</button>
      <button class="btn sm" onclick="localStorage.clear();location.reload()">初期化</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid">
    <!-- 左：入力 -->
    <section class="card left-col">
      <div class="hd">
        <strong>入力（付加価値額→月次顧問料）</strong>
        <div class="seg noprint">
          <button id="tab-v" class="active">付加価値</button>
          <button id="tab-s">サービス選択</button>
        </div>
      </div>

      <!-- 付加価値入力 -->
      <div class="bd" id="pane-v">
        <div class="wrap">
          <span class="pill">区分：<b id="ent-label">法人</b></span>
        </div>
        <div class="divider"></div>

        <div id="calc-corp">
          <div class="mini">算式（法人）：<b>経常利益＋人件費＋支払利息＋賃借料＋リース料＋租税公課＋減価償却費</b></div>
          <div class="divider"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem">
            <div><div class="mini">経常利益</div><input id="c_ordinary" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">人件費</div><input id="c_labor" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">支払利息</div><input id="c_int" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">賃借料</div><input id="c_rent" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">リース料</div><input id="c_lease" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">租税公課</div><input id="c_tax" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">減価償却費</div><input id="c_dep" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
          </div>
        </div>

        <div id="calc-sole" style="display:none">
          <div class="mini">算式（個人）：<b>青色控除前利益＋青色専従者給与＋人件費＋支払利息＋賃借料＋リース料＋租税公課＋減価償却費＋3,000,000</b></div>
          <div class="divider"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem">
            <div><div class="mini">青色控除前利益</div><input id="s_preprofit" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">青色専従者給与</div><input id="s_family" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">人件費</div><input id="s_labor" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">支払利息</div><input id="s_int" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">賃借料</div><input id="s_rent" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">リース料</div><input id="s_lease" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">租税公課</div><input id="s_tax" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">減価償却費</div><input id="s_dep" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="wrap">
          <span class="pill">付加価値額：<b id="vadd">0</b> 円/年</span>
          <span class="pill">該当帯：<b id="band">—</b></span>
          <span class="pill">月次顧問料（税抜）：<b id="monthly">¥0</b></span>
        </div>
        <div class="divider"></div>

        <!-- 折りたたみ：付加価値帯ーテーブル -->
        <details id="bandsWrap" class="details">
          <summary class="pill" style="display:inline-flex;align-items:center;gap:.5rem">
            <span class="caret">▶</span>
            <span>付加価値帯ー月次顧問料（税抜）</span>
            <span class="mini">（クリックで展開）</span>
          </summary>
          <div style="margin-top:.5rem">
            <table id="bands">
              <thead><tr><th>付加価値帯</th><th>月次顧問料（税抜）</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>

      <!-- サービス選択 -->
      <div class="bd" id="pane-s" style="display:none">
        <div class="mini">必要な項目にチェック／数量入力（下記の一部は「月次顧問料」を基礎に自動算定します）。
          <span class="pill">区分：<b id="ent-label2">法人</b></span>
        </div>
        <div class="divider"></div>
        <div id="services"></div>
        <div class="divider"></div>
        <button id="btn-show-quote" class="btn primary">お見積り ▶</button>
      </div>

      <!-- 調整：自由記入（左カラム最下部へ移設） -->
      <div class="bd" id="pane-adj">
        <div class="card" style="width:100%">
          <div class="hd"><strong>調整（自由記入）</strong><span class="mini">値引きはマイナスで入力</span></div>
          <div class="bd">
            <div class="wrap" style="align-items:flex-end">
              <div style="flex:2;min-width:200px">
                <div class="mini">メモ</div>
                <input id="adj-memo" type="text" placeholder="例：値引き・端数調整など">
              </div>
              <div style="flex:1;min-width:200px">
                <div class="mini">調整額（±）</div>
                <input id="adj-amt" type="text" inputmode="numeric" data-commas data-negative placeholder="0">
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 右：見積（初期は非表示） -->
    <section class="card quote-section">
      <div class="hd">
        <strong>見積（自動計算）</strong>
        <div class="wrap noprint">
          <div class="wrap" style="align-items:center">
            <div class="mini">宛名</div>
            <input id="client-name" type="text" placeholder="（例）株式会社〇〇 御中" style="min-width:200px">
            <div class="mini">作成日</div>
            <input id="doc-date-input" type="date" style="min-width:160px">
          </div>
          <button class="btn" id="copy-btn">内訳コピー</button>
          <button class="btn" onclick="window.print()">印刷/PDF</button>
        </div>
      </div>
      <div class="bd">
        <!-- 印刷時ヘッダー -->
        <div class="print-header">
          <div class="print-meta">
            <div class="to">宛名：<span id="print-to">&nbsp;</span></div>
            <div class="date">作成年月日：<span id="print-date">&nbsp;</span></div>
          </div>
          <h1>御見積書</h1>
        </div>

        <table id="quote">
          <thead><tr><th>項目</th><th>区分</th><th>数量</th><th>単価</th><th>小計</th></tr></thead>
        <tbody id="q-body"></tbody>
          <tfoot>
            <tr><td colspan="4">月額小計</td><td id="sum-m">¥0</td></tr>
            <tr><td colspan="4">年額小計（=月額×12）</td><td id="sum-y">¥0</td></tr>
            <tr><td colspan="4">スポット</td><td id="sum-o">¥0</td></tr>
            <tr><td colspan="4">消費税</td><td id="sum-tax">¥0</td></tr>
            <tr><td colspan="4">合計</td><td id="sum-t" style="font-weight:800">¥0</td></tr>
          </tfoot>
        </table>
        <div class="mini" style="margin-top:.5rem">※ 学校法人・社福・宗教・NPO・公益等は<b>別途御見積り</b>扱い。</div>
      </div>
    </section>
  </div>

  <!-- テスト用：簡易ハーネス -->
  <details class="card" style="margin-top:1rem">
    <summary class="hd" style="cursor:pointer"><strong>🔧 開発者向けテスト（r4.4）</strong><span class="mini">クリックで展開</span></summary>
    <div class="bd">
      <button class="btn ok" id="run-tests">テスト実行</button>
      <ul id="test-log" class="mini" style="margin-top:.5rem"></ul>
    </div>
  </details>
</div>

<footer class="mk-mini">
  <div class="inner">
    © <span id="cpy-year"></span> <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener">税理士法人松本会計事務所</a> ｜
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ja" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> ｜
    <a href="#" onclick="alert('本ツールは概算見積の補助を目的としています。最終報酬額は個別契約・業務範囲・繁忙度・データ品質等により調整します。');return false;">利用条件</a> ｜
    <span id="rev"></span>
  </div>
</footer>

<script>
const APP_VER = 'r4.4';
const el=(id)=>document.getElementById(id);
const fmt=(n)=> (isNaN(n)?0:n).toLocaleString('ja-JP');
const yen=(n)=>'¥'+fmt(Math.round(n||0));
const TAX=0.10;

let showQuote = false; // 初期は右カラム非表示

// 区分（法人/個人）
let ent = localStorage.getItem('mk_ent')||'corp';

// 帯テーブル
const bandsCorp=[
  {min:0, max:5000000, fee:35000},
  {min:5000000, max:10000000, fee:37000},
  {min:10000000, max:20000000, fee:39000},
  {min:20000000, max:30000000, fee:41000},
  {min:30000000, max:50000000, fee:45000},
  {min:50000000, max:70000000, fee:49000},
  {min:70000000, max:100000000, fee:55000},
  {min:100000000, max:200000000, fee:73000},
  {min:200000000, max:300000000, fee:89000},
  {min:300000000, max:500000000, fee:105000},
  {min:500000000, max:700000000, fee:119000},
  {min:700000000, max:1000000000, fee:125000},
  {min:1000000000, max:2000000000, fee:143000},
  {min:2000000000, max:3000000000, fee:170000},
  {min:3000000000, max:5000000000, fee:215000},
  {min:5000000000, max:10000000000, fee:260000},
  {min:10000000000, max:Infinity, fee:null}
];
const bandsSole=[
  {min:0, max:5000000, fee:27000},
  {min:5000000, max:10000000, fee:29000},
  {min:10000000, max:20000000, fee:31000},
  {min:20000000, max:30000000, fee:33000},
  {min:30000000, max:50000000, fee:37000},
  {min:50000000, max:70000000, fee:41000},
  {min:70000000, max:100000000, fee:47000},
  {min:100000000, max:Infinity, fee:null}
];

// サービスマスタ
const servicesMaster=[
  {ent:'both',cat:"月次顧問", name:"月次顧問料（付加価値ベース）", unit:"月額", kind:"fixed", price:0, qty:1, allowQty:false, note:"付加価値帯から自動設定"},

  {ent:'corp',cat:"決算・申告（法人）", name:"法人決算・申告一式", unit:"スポット", kind:"mult_m", months:4, price:0, qty:0, allowQty:false, note:"月次顧問報酬の4ヶ月分"},
  {ent:'corp',cat:"決算・申告（法人）", name:"消費税申告書作成", unit:"スポット", kind:"mult_m", months:2, price:0, qty:0, allowQty:false, note:"月次顧問報酬の2ヶ月分"},

  {ent:'both',cat:"年末調整", name:"年末調整 基本料金", unit:"スポット", kind:"fixed", price:20000, qty:0, allowQty:false, note:"法定調書合計表含む"},
  {ent:'both',cat:"年末調整", name:"年末調整 人数（1人目から）", unit:"スポット", kind:"per_qty", price:3000, qty:0, allowQty:true, note:"×人数"},

  {ent:'both',cat:"償却資産税申告", name:"償却資産税申告（市町村・件数）", unit:"スポット", kind:"asset_tax", base:10000, extra:3000, qty:0, allowQty:true, note:"基本10,000円＋（件数-1）×3,000円"},

  {ent:'both',cat:"ソフトウェアレンタル", name:"FX4クラウド", unit:"月額", kind:"fixed", price:60000, qty:0, allowQty:false, editablePrice:true},
  {ent:'both',cat:"ソフトウェアレンタル", name:"FX2クラウド", unit:"月額", kind:"fixed", price:15000, qty:0, allowQty:false, editablePrice:true},
  {ent:'both',cat:"ソフトウェアレンタル", name:"FXまいスタークラウド", unit:"月額", kind:"fixed", price:12000, qty:0, allowQty:false, editablePrice:true},
  {ent:'both',cat:"ソフトウェアレンタル", name:"（その他）", unit:"月額", kind:"group_other", price:0, qty:0, allowQty:false, note:"クリックで展開"},
  {ent:'both',cat:"ソフトウェアレンタル", name:"PX4クラウド", unit:"月額", kind:"fixed", price:0, qty:0, allowQty:false, editablePrice:true, swOther:true}
];

let services = [];
function resetServices(){ services = servicesMaster.filter(s=> s.ent==='both' || s.ent===ent).map(s=>({...s})); }
function loadServices(){ const ver = localStorage.getItem('mk_ver'); if(ver!==APP_VER){ localStorage.clear(); localStorage.setItem('mk_ver', APP_VER);} resetServices(); }
function persist(){ /* 必要に応じて保存 */ }

// 調整（左カラム）
let adjust = { memo:'', amt:0 };

// 数値ユーティリティ（リアルタイムカンマ）
function parseNum(str, allowNegative=false){
  if(typeof str!=='string') str = String(str||'');
  const s = str.replace(/,/g,'').replace(/[\s\u00A0]/g,'');
  if(allowNegative){ return parseFloat(s.replace(/[^0-9.-]/g,'')) || 0; }
  return parseFloat(s.replace(/[^0-9.]/g,'')) || 0;
}
function formatNum(n){ return fmt(parseFloat(n||0)); }
function bindCommaInput(input, opts={}){
  const allowNeg = !!opts.allowNegative;
  const onFmt = ()=>{
    const num = parseNum(input.value, allowNeg);
    input.value = formatNum(num * (allowNeg?1:1));
    if(input.dataset.role==='vadd'){ recalc(); }
  };
  input.addEventListener('input', onFmt);
  input.addEventListener('blur', onFmt);
}

function setEnt(v){
  ent=v; localStorage.setItem('mk_ent', ent);
  document.getElementById('ent-corp').classList.toggle('active', ent==='corp');
  document.getElementById('ent-sole').classList.toggle('active', ent==='sole');
  el('ent-label').textContent = ent==='corp'?'法人':'個人';
  el('ent-label2').textContent = ent==='corp'?'法人':'個人';
  loadServices();
  renderBands();
  recalc();
}
window.setEnt = setEnt;

function renderBands(){
  const tbody = el('bands').querySelector('tbody'); tbody.innerHTML='';
  const b = (ent==='corp'?bandsCorp:bandsSole);
  b.forEach(x=>{
    const tr=document.createElement('tr');
    const label = x.max===Infinity ? `${fmt(x.min)}円超` : `${fmt(x.min)}〜${fmt(x.max)}円`;
    tr.innerHTML = `<td>${label}</td><td>${x.fee?yen(x.fee):'別途お見積り'}</td>`;
    tbody.appendChild(tr);
  });
}

function getVal(id, allowNeg=false){ return parseNum(el(id).value||'0', allowNeg); }

function calcVadd(){
  if(ent==='corp'){
    return Math.max(0,
      getVal('c_ordinary')+getVal('c_labor')+getVal('c_int')+getVal('c_rent')+
      getVal('c_lease')+getVal('c_tax')+getVal('c_dep')
    );
  }else{
    return Math.max(0,
      getVal('s_preprofit')+getVal('s_family')+getVal('s_labor')+getVal('s_int')+
      getVal('s_rent')+getVal('s_lease')+getVal('s_tax')+getVal('s_dep')+3000000
    );
  }
}

function bandFee(v){
  const arr = (ent==='corp'?bandsCorp:bandsSole);
  for(const x of arr){ if(v>=x.min && v<x.max){ return x.fee; } }
  return null;
}

function recalc(){
  const corp = ent==='corp';
  el('calc-corp').style.display = corp?'block':'none';
  el('calc-sole').style.display = corp?'none':'block';
  const v = calcVadd();
  el('vadd').textContent = fmt(v);
  const fee = bandFee(v);
  const monthly = fee? fee : 0;
  el('monthly').textContent = yen(monthly);
  const arr = (ent==='corp'?bandsCorp:bandsSole);
  const band = arr.find(x=>v>=x.min && v<x.max);
  el('band').textContent = band ? (band.max===Infinity?`${fmt(band.min)}円超`:`${fmt(band.min)}〜${fmt(band.max)}円`) : '—';
  if(services.length && services[0].cat==='月次顧問') services[0].price = monthly;
  renderServices();
  renderQuote();
}

function renderServices(){
  const host = el('services'); host.innerHTML='';
  const orderCorp = ["月次顧問","ソフトウェアレンタル","決算・申告（法人）","年末調整","償却資産税申告","個人確定申告"];
  const orderSole = ["月次顧問","ソフトウェアレンタル","個人確定申告","年末調整","償却資産税申告","決算・申告（法人）"];
  const order = ent==='corp'?orderCorp:orderSole;
  const cats = [...new Set(services.map(x=>x.cat))].sort((a,b)=> order.indexOf(a)-order.indexOf(b));

  cats.forEach(c=>{
    const items = services.filter(x=>x.cat===c);
    if(!items.length) return;
    const box=document.createElement('div'); box.className='card'; box.style.marginBottom='.6rem';
    box.innerHTML = `<div class=\"hd\"><strong>${c}</strong><span class=\"mini\">${items.length}項目</span></div>`;
    const bd=document.createElement('div'); bd.className='bd';

    if(c==='ソフトウェアレンタル'){
      const primaries = items.filter(x=>!x.swOther && x.kind!=='group_other');
      const others = items.filter(x=>x.swOther);
      const orderNames = ['FX4クラウド','FX2クラウド','FXまいスタークラウド'];
      primaries.sort((a,b)=> orderNames.indexOf(a.name)-orderNames.indexOf(b.name));
      primaries.forEach(it=> bd.appendChild(renderServiceRow(it)));
      const grp = items.find(x=>x.kind==='group_other');
      if(grp){
        const det = document.createElement('details'); det.className='details';
        const sum = document.createElement('summary'); sum.className='pill'; sum.style.display='inline-flex'; sum.style.alignItems='center'; sum.style.gap='.5rem';
        sum.innerHTML = `<span class=\"caret\">▶</span><span>その他</span><span class=\"mini\">（クリックで展開）</span>`;
        det.appendChild(sum);
        const inner=document.createElement('div'); inner.style.marginTop='.5rem';
        others.forEach(it=> inner.appendChild(renderServiceRow(it)));
        const addBox=document.createElement('div'); addBox.className='wrap'; addBox.style.marginTop='.5rem';
        addBox.innerHTML = `
          <input id=\"custom-soft-name\" type=\"text\" placeholder=\"ソフト名（例：XXXクラウド）\" style=\"max-width:220px\">
          <input id=\"custom-soft-price\" type=\"text\" inputmode=\"numeric\" data-commas placeholder=\"月額単価\" style=\"max-width:150px\">
          <button class=\"btn sm\" type=\"button\" onclick=\"addCustomSoft()\">追加</button>
          <span class=\"mini\">※ 追加すると下の一覧に現れます</span>`;
        inner.appendChild(addBox);
        det.appendChild(inner); bd.appendChild(det);
      }
      box.appendChild(bd); host.appendChild(box); return;
    }

    items.forEach(it=> bd.appendChild(renderServiceRow(it)));
    box.appendChild(bd); host.appendChild(box);
  });

  // 追加：お見積りボタンは pane-s 内に配置済み

  // 新規追加要素にフォーマッタ付与
  document.querySelectorAll('#services input[data-commas]').forEach(inp=>bindCommaInput(inp,{allowNegative:false}));
}

function renderServiceRow(it){
  const idx = services.indexOf(it);
  const id = `svc_${it.cat}_${idx}`;
  const row=document.createElement('div'); row.className='wrap'; row.style.justifyContent='space-between';
  const left=document.createElement('div'); left.style.flex='1';
  left.innerHTML = `<label for="${id}" style="display:block">${it.name} <span class="mini">(${it.unit})</span></label><div class="mini">${it.note||''}</div>`;
  const right=document.createElement('div'); right.className='wrap';

  let priceCtrl = `<span class="pill">単価 <b>${it.kind==='mult_m' ? '＝月次×'+it.months : yen(it.price)}</b></span>`;
  if(it.kind==='asset_tax') priceCtrl = `<span class=\"pill\">単価 <b>${yen(it.base)}＋${yen(it.extra)}×(件数-1)</b></span>`;
  if(it.editablePrice){
    priceCtrl = `<span class="pill">単価 <input type="text" inputmode="numeric" data-commas value="${fmt(it.price||0)}" style="width:120px" oninput="setPrice(${idx}, this.value)"></span>`;
  }

  right.innerHTML = `
    ${it.allowQty?`<input id="${id}_qty" type="text" inputmode="numeric" data-commas value="${fmt(it.qty||0)}" style="width:110px" oninput="setQty(${idx}, this.value)">`:`<span class="pill">${it.qty>0?'選択中':'数量固定'}</span>`}
    ${priceCtrl}
    ${it.kind!=='group_other'?`<input id="${id}" type="checkbox" ${it.qty>0?'checked':''} onchange="toggle(${idx}, this.checked)">`:''}
  `;
  row.appendChild(left); row.appendChild(right);
  return row;
}

function toggle(i, on){
  const it = services[i];
  if(it.allowQty){ it.qty = on ? (it.qty||1) : 0; }
  else{ it.qty = on ? 1 : 0; }
  renderQuote();
}
function setQty(i, v){ services[i].qty = Math.max(0, parseNum(v)); renderQuote(); }
function setPrice(i, v){ services[i].price = Math.max(0, parseNum(v)); renderQuote(); }

function renderQuote(){
  const body = el('q-body'); body.innerHTML='';
  let m=0,o=0;
  services.forEach(it=>{
    const q = +it.qty||0; if(!q || it.kind==='group_other') return;
    let unitPrice = 0, lineSub = 0;
    if(it.kind==='mult_m'){
      unitPrice = (services[0].price||0)*it.months; lineSub = unitPrice * q;
    }else if(it.kind==='per_qty'){
      unitPrice = (it.price||0)*q; lineSub = unitPrice;
    }else if(it.kind==='asset_tax'){
      lineSub = q>=1 ? (it.base + Math.max(0, q-1)*it.extra) : 0;
    }else{
      unitPrice = it.price||0; lineSub = unitPrice * q;
    }
    const unitDisp = (it.kind==='mult_m') ? ('月次×'+it.months) : (it.kind==='asset_tax' ? `${yen(it.base)}＋${yen(it.extra)}×(件数-1)` : yen(it.price));
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${it.name}</td><td>${it.unit}</td><td>${fmt(q)}</td><td>${unitDisp}</td><td>${yen(lineSub)}</td>`;
    body.appendChild(tr);
    if(it.unit==='月額'){ m += lineSub; } else { o += lineSub; }
  });
  const y = m*12;
  const base = (m+y+o) + (adjust.amt||0);
  const tax = Math.round(base*TAX);
  const total = base + tax;
  el('sum-m').textContent=yen(m);
  el('sum-y').textContent=yen(y);
  el('sum-o').textContent=yen(o);
  el('sum-tax').textContent=yen(tax);
  el('sum-t').textContent=yen(total);
}

function copySummary(){
  const lines=['【見積内訳】'];
  services.forEach(it=>{
    const q=+it.qty||0; if(!q || it.kind==='group_other') return;
    const descr = it.kind==='mult_m' ? `(月次×${it.months})` : (it.kind==='asset_tax' ? `(基本${yen(it.base)}＋${yen(it.extra)}×(件数-1))` : '');
    let sub=0;
    if(it.kind==='mult_m'){ sub = (services[0].price||0)*it.months*q; }
    else if(it.kind==='per_qty'){ sub = (it.price||0)*q; }
    else if(it.kind==='asset_tax'){ sub = q>=1 ? (it.base + Math.max(0, q-1)*it.extra) : 0; }
    else{ sub = (it.price||0)*q; }
    lines.push(`・${it.name}（${it.unit}）${descr}：数量${q} × ${it.kind==='mult_m'?'月次×'+it.months:(it.kind==='asset_tax'?`${yen(it.base)}＋${yen(it.extra)}×(件数-1)`:yen(it.price))} = ${yen(sub)}`);
  });
  if((adjust.amt||0)!==0){ lines.push(`調整：${yen(adjust.amt)}（${(adjust.memo||'').trim()||'—'}）`); }
  lines.push(`月額小計：${el('sum-m').textContent}`);
  lines.push(`年額小計：${el('sum-y').textContent}`);
  lines.push(`スポット：${el('sum-o').textContent}`);
  lines.push(`消費税：${el('sum-tax').textContent}`);
  lines.push(`合計：${el('sum-t').textContent}`);
  navigator.clipboard.writeText(lines.join('\n')).then(()=>alert('内訳をコピーしました。'));
}

function switchTab(k){
  el('pane-v').style.display = k==='v'?'block':'none';
  el('pane-s').style.display = k==='s'?'block':'none';
  el('tab-v').classList.toggle('active', k==='v');
  el('tab-s').classList.toggle('active', k==='s');
}

function addCustomSoft(){
  const name = (document.getElementById('custom-soft-name').value||'').trim();
  const price = parseNum(document.getElementById('custom-soft-price').value||'0');
  if(!name || price<=0){ alert('名称と月額単価を入力してください'); return; }
  services.push({ent:'both',cat:'ソフトウェアレンタル',name,unit:'月額',kind:'fixed',price,qty:0,allowQty:false,editablePrice:true,swOther:true});
  renderServices();
  document.getElementById('custom-soft-name').value='';
  document.getElementById('custom-soft-price').value='';
}

function logTest(ok,msg){
  const li=document.createElement('li');
  li.className= ok? 'test-pass':'test-fail';
  li.textContent = (ok?'✔ ':'✖ ')+msg;
  el('test-log').appendChild(li);
}
function clearTests(){ el('test-log').innerHTML=''; }

function formatDateJP(iso){
  try{ const d= iso? new Date(iso): new Date(); return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`; }catch(e){ return ''; }
}

// 初期化
(function init(){
  const d=new Date(document.lastModified);
  el('cpy-year').textContent=String(new Date().getFullYear());
  el('rev').textContent=APP_VER+'（'+d.toISOString().slice(0,10)+'）';

  // クリックイベント
  document.getElementById('ent-corp').addEventListener('click', ()=>setEnt('corp'));
  document.getElementById('ent-sole').addEventListener('click', ()=>setEnt('sole'));
  document.getElementById('tab-v').addEventListener('click', ()=>switchTab('v'));
  document.getElementById('tab-s').addEventListener('click', ()=>switchTab('s'));
  document.getElementById('copy-btn').addEventListener('click', copySummary);
  document.getElementById('btn-show-quote').addEventListener('click', ()=>{ showQuote=true; document.querySelector('.quote-section').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); });

  // 宛名・作成日
  el('doc-date-input').value = (new Date()).toISOString().slice(0,10);
  window.addEventListener('beforeprint', ()=>{
    el('print-to').textContent = (el('client-name').value||'').trim()||'';
    el('print-date').textContent = formatDateJP(el('doc-date-input').value);
  });

  // 調整入力
  bindCommaInput(el('adj-amt'), {allowNegative:true});
  el('adj-memo').addEventListener('input', (e)=>{ adjust.memo=e.target.value||''; });
  el('adj-amt').addEventListener('input', (e)=>{ adjust.amt=parseNum(e.target.value||'0', true)||0; renderQuote(); });

  // 付加価値入力にフォーマッタ付与
  document.querySelectorAll('input[data-role="vadd"]').forEach(inp=> bindCommaInput(inp));

  // 初期UI
  document.getElementById('ent-corp').classList.toggle('active', ent==='corp');
  document.getElementById('ent-sole').classList.toggle('active', ent==='sole');
  el('ent-label').textContent = ent==='corp'?'法人':'個人';
  el('ent-label2').textContent = ent==='corp'?'法人':'個人';

  loadServices();
  renderBands();
  recalc();

  // 初期は右カラム非表示
  document.querySelector('.quote-section').style.display='none';

  // テスト
  document.getElementById('run-tests').addEventListener('click', ()=>{
    clearTests();
    try{
      // 1) 初期：右カラム非表示
      logTest(getComputedStyle(document.querySelector('.quote-section')).display==='none', '初期状態で右カラムが非表示');
      // 2) 付加価値入力のカンマ表示
      el('c_labor').value='12345'; el('c_labor').dispatchEvent(new Event('input')); // -> 12,345
      logTest(el('c_labor').value==='12,345', 'カンマ表示：c_labor=12,345');
      // 3) お見積りボタンで右カラム表示
      document.getElementById('btn-show-quote').click();
      logTest(getComputedStyle(document.querySelector('.quote-section')).display!=='none', 'お見積り押下で右カラム表示');
      // 4) 償却資産税申告：件数3→16,000
      const idxA = services.findIndex(s=>s.kind==='asset_tax'); services[idxA].qty=3; renderQuote();
      const rows=[...document.querySelectorAll('#quote tbody tr')];
      const assetRow = rows.find(r=>r.children[0].textContent.includes('償却資産税申告'));
      const subTxt = assetRow ? assetRow.children[4].textContent.replace(/[^0-9]/g,'') : '0';
      logTest(subTxt==='16000', '償却資産税申告（3件）=16,000');
      // 5) 調整（-5,000）で合計が減少
      el('adj-amt').value='-5,000'; el('adj-amt').dispatchEvent(new Event('input'));
      const totalAfter = parseInt(document.getElementById('sum-t').textContent.replace(/[^0-9]/g,''),10);
      el('adj-amt').value='0'; el('adj-amt').dispatchEvent(new Event('input'));
      const totalBefore = parseInt(document.getElementById('sum-t').textContent.replace(/[^0-9]/g,''),10);
      logTest(totalAfter < totalBefore, '調整（-5,000）で合計が減少');
    }catch(e){ logTest(false, 'テスト例外: '+(e&&e.message)); }
  });
})();
</script>
</body>
</html>
