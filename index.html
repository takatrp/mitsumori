<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>松本会計｜報酬見積ツール r4.5（見積様式対応）</title>
<style>
:root{
  --mk-bg:#f7fafc; --mk-card:#fff; --mk-ink:#1a202c; --mk-sub:#4a5568; --mk-border:#e2e8f0;
  --mk-primary:#578899; --ok:#2f855a; --warn:#c05621; --gray:#718096; --line:#cbd5e0;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--mk-bg);color:var(--mk-ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",Meiryo,sans-serif}

/* 共通 */
.container{max-width:1100px;margin:1rem auto;padding:0 .75rem 6rem}
.btn{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--mk-border);background:#fff;border-radius:999px;padding:.5rem .9rem;font-weight:600;cursor:pointer}
.btn.primary{background:var(--mk-primary);border-color:var(--mk-primary);color:#fff}
.btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.seg{display:flex;border:1px solid var(--mk-border);border-radius:10px;overflow:hidden}
.seg button{border:0;background:#fff;padding:.5rem .8rem;cursor:pointer}
.seg button.active{background:var(--mk-primary);color:#fff}
.card{background:#fff;border:1px solid var(--mk-border);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
.card .hd{display:flex;justify-content:space-between;align-items:center;padding:.85rem 1rem;border-bottom:1px dashed var(--mk-border)}
.card .bd{padding:1rem}
.pill{font-size:.85rem;border:1px solid var(--mk-border);border-radius:999px;padding:.2rem .6rem;background:#fff}
.divider{height:1px;background:linear-gradient(to right,transparent,var(--mk-border),transparent);margin:.75rem 0}
.mini{font-size:.85rem;color:var(--gray)}
input[type="text"],input[type="date"]{width:100%;border:1px solid var(--mk-border);border-radius:10px;padding:.55rem .7rem;font-size:1rem;background:#fff}
input[data-commas]{text-align:right}
summary{list-style:none;cursor:pointer}
summary .caret{display:inline-block;transition:transform .2s}
.details[open] summary .caret{transform:rotate(90deg)}

/* ヘッダー */
header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#fff,rgba(255,255,255,.92));border-bottom:1px solid var(--mk-border);backdrop-filter:blur(4px)}
.bar{max-width:1100px;margin:0 auto;padding:.8rem .8rem;display:flex;justify-content:space-between;align-items:center;gap:.6rem}
.title{font-weight:800}
.badge{background:var(--mk-primary);color:#fff;border-radius:999px;padding:.15rem .55rem;font-size:.75rem}

/* ビュー切替（入力 / 見積） */
.view{display:none}
.view.active{display:block}

/* 印刷版（御見積書）レイアウト */
.quote-wrap{background:#fff;border:1px solid #999}
.q-head{padding:20px 24px;border-bottom:2px solid #000}
.q-title{font-size:24px;letter-spacing:.3em;text-align:center;margin:0 0 8px 0}
.q-toprow{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.q-topbox{font-size:.95rem;color:#000}
.q-topbox .row{display:flex;gap:8px;align-items:center;margin:.2rem 0}
.q-issuer{border:1px solid #000;padding:12px;min-width:320px}
.q-issuer .name{font-weight:800;font-size:1.05rem;margin-bottom:.3rem}
.q-issuer .row{display:flex;gap:8px;align-items:center}
.q-summary{margin:18px 24px;border:2px solid #000;padding:12px 16px;display:flex;gap:16px;align-items:center}
.q-summary .label{font-weight:700}
.q-summary .amt{font-size:1.4rem;font-weight:800}

/* 見積テーブル */
.q-table{width:calc(100% - 48px);margin:0 24px 24px;border-collapse:collapse;border:1px solid #000}
.q-table th,.q-table td{border:1px solid #000;padding:8px 10px}
.q-table thead th{background:#e2e8f0}
.q-table th:nth-child(1){width:56%;text-align:left}
.q-table th:nth-child(2){width:12%}
.q-table th:nth-child(3){width:14%}
.q-table th:nth-child(4){width:18%}
.q-table td{text-align:right}
.q-table td:first-child{text-align:left}
.q-subtotal-row td{background:#f1f5f9}
.q-totalbox{width:calc(100% - 48px);margin:0 24px 24px}
.q-totalbox .grid{display:grid;grid-template-columns:1fr 260px;gap:0}
.q-totalbox .labels{border-left:1px solid #000;border-right:1px solid #000;border-bottom:1px solid #000}
.q-totalbox .labels .row{display:flex;justify-content:space-between;border-top:1px solid #000;padding:8px 10px}
.q-totalbox .labels .row .name{margin-right:16px}
.q-totalbox .labels .row.total{background:#e2e8f0;font-weight:800}

.q-notes{width:calc(100% - 48px);margin:0 24px 28px;border:1px solid #000}
.q-notes .hd{background:#e2e8f0;border-bottom:1px solid #000;padding:6px 10px;font-weight:700}
.q-notes .bd{padding:10px}

/* 印刷CSS */
@media print{
  header,.noprint,.view#view-input,footer{display:none!important}
  body{background:#fff}
  .view#view-quote{display:block!important}
}
footer.mk-mini{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--mk-border);padding:.5rem .75rem;font-size:.8rem}
footer.mk-mini .inner{max-width:1100px;margin:0 auto;display:flex;gap:.6rem;flex-wrap:wrap}
footer.mk-mini a{color:inherit;text-decoration:underline}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="wrap" style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap">
      <span class="title">報酬見積ツール</span>
      <span class="badge">r4.5</span>
      <span class="mini">松本会計｜スマホ対応</span>
      <div class="seg noprint" aria-label="区分切替">
        <button id="ent-corp">法人</button>
        <button id="ent-sole">個人</button>
      </div>
    </div>
    <div class="wrap noprint" style="display:flex;gap:.6rem;align-items:center">
      <button class="btn" id="btn-go-quote">御見積書を見る</button>
      <button class="btn" id="btn-back-input" style="display:none">入力に戻る</button>
      <button class="btn" onclick="window.print()">印刷/PDF</button>
      <button class="btn" onclick="localStorage.clear();location.reload()">初期化</button>
    </div>
  </div>
</header>

<div class="container">
  <!-- 入力ビュー -->
  <section id="view-input" class="view active">
    <div class="card">
      <div class="hd">
        <strong>入力（付加価値額→月次顧問料）</strong>
        <div class="seg noprint">
          <button id="tab-v" class="active">付加価値</button>
          <button id="tab-s">サービス選択</button>
        </div>
      </div>
      <div class="bd" id="pane-v">
        <div class="wrap"><span class="pill">区分：<b id="ent-label">法人</b></span></div>
        <div class="divider"></div>
        <div id="calc-corp">
          <div class="mini">算式（法人）：<b>経常利益＋人件費＋支払利息＋賃借料＋リース料＋租税公課＋減価償却費</b></div>
          <div class="divider"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem">
            <div><div class="mini">経常利益</div><input id="c_ordinary" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">人件費</div><input id="c_labor" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">支払利息</div><input id="c_int" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">賃借料</div><input id="c_rent" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">リース料</div><input id="c_lease" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">租税公課</div><input id="c_tax" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">減価償却費</div><input id="c_dep" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
          </div>
        </div>
        <div id="calc-sole" style="display:none">
          <div class="mini">算式（個人）：<b>青色控除前利益＋青色専従者給与＋人件費＋支払利息＋賃借料＋リース料＋租税公課＋減価償却費＋3,000,000</b></div>
          <div class="divider"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem">
            <div><div class="mini">青色控除前利益</div><input id="s_preprofit" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">青色専従者給与</div><input id="s_family" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">人件費</div><input id="s_labor" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">支払利息</div><input id="s_int" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">賃借料</div><input id="s_rent" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">リース料</div><input id="s_lease" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">租税公課</div><input id="s_tax" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
            <div><div class="mini">減価償却費</div><input id="s_dep" type="text" inputmode="numeric" data-commas data-role="vadd"></div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="wrap">
          <span class="pill">付加価値額：<b id="vadd">0</b> 円/年</span>
          <span class="pill">該当帯：<b id="band">—</b></span>
          <span class="pill">月次顧問料（税抜）：<b id="monthly">¥0</b></span>
        </div>
        <div class="divider"></div>
        <details id="bandsWrap" class="details">
          <summary class="pill"><span class="caret">▶</span> 付加価値帯ー月次顧問料（税抜）</summary>
          <div style="margin-top:.5rem">
            <table id="bands" style="width:100%;border-collapse:collapse">
              <thead><tr><th style="text-align:left">付加価値帯</th><th style="text-align:right">月次顧問料（税抜）</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>

      <div class="bd" id="pane-s" style="display:none">
        <div class="mini">必要な項目にチェック／数量入力（下記の一部は「月次顧問料」を基礎に自動算定します）。<span class="pill">区分：<b id="ent-label2">法人</b></span></div>
        <div class="divider"></div>
        <div id="services"></div>
        <div class="divider"></div>
        <!-- 調整（サービス選択の直上に移設） -->
        <div class="card" style="margin:.2rem 0 1rem 0">
          <div class="hd"><strong>調整（自由記入）</strong><span class="mini">値引きはマイナスで入力</span></div>
          <div class="bd">
            <div class="wrap" style="align-items:flex-end">
              <div style="flex:2;min-width:220px">
                <div class="mini">メモ</div>
                <input id="adj-memo" type="text" placeholder="例：値引き・端数調整など">
              </div>
              <div style="flex:1;min-width:200px">
                <div class="mini">調整額（±）</div>
                <input id="adj-amt" type="text" inputmode="numeric" data-commas data-negative placeholder="0">
              </div>
            </div>
          </div>
        </div>
        <button id="btn-show-quote" class="btn primary">お見積り ▶</button>
      </div>
    </div>
  </section>

  <!-- 御見積書ビュー（画面切替でフル幅表示） -->
  <section id="view-quote" class="view">
    <div class="quote-wrap">
      <div class="q-head">
        <div class="q-title">御　見　積　書</div>
        <div class="q-toprow">
          <div class="q-topbox">
            <div class="row" style="font-size:1.05rem"><strong id="to-line">（宛名未入力） 御中</strong></div>
            <div class="row mini">下記の通りお見積もり申し上げます。</div>
          </div>
          <div class="q-topbox" style="text-align:right">
            <div class="row"><span class="mini">見積日：</span><input id="doc-date" type="date" style="width:160px"></div>
            <div class="row"><span class="mini">見積番号：</span><input id="doc-no" type="text" placeholder="例：20250205-01" style="width:160px"></div>
          </div>
        </div>
        <div class="q-toprow" style="margin-top:8px">
          <div class="q-topbox"></div>
          <div class="q-issuer">
            <div class="name"><input id="issuer-name" type="text" value="税理士法人松本会計事務所"/></div>
            <div class="row"><span class="mini">【拠点】</span><input id="issuer-branch" type="text" value="【神戸事務所】"/></div>
            <div class="row"><span class="mini">〒</span><input id="issuer-addr" type="text" placeholder="住所"/></div>
            <div class="row"><span class="mini">TEL </span><input id="issuer-tel" type="text" placeholder="電話番号"/></div>
            <div class="row"><span class="mini">代表</span><input id="issuer-rep" type="text" placeholder="代表者名"/></div>
          </div>
        </div>
      </div>

      <div class="q-summary">
        <div class="label">御見積金額（年間）</div>
        <div class="amt" id="grand-tax-in">¥0（税込）</div>
      </div>

      <table class="q-table" id="q-table">
        <thead>
          <tr>
            <th>報酬内容</th><th>数量</th><th>月単価</th><th>年間金額</th>
          </tr>
        </thead>
        <tbody id="q-tbody"></tbody>
      </table>

      <div class="q-totalbox">
        <div class="grid">
          <div></div>
          <div class="labels" id="q-totals">
            <!-- rows injected -->
          </div>
        </div>
      </div>

      <div class="q-notes">
        <div class="hd">備　考</div>
        <div class="bd">
          <ul id="q-notes-list" class="mini" style="margin:0 0 .3rem 1rem"></ul>
          <div class="mini">※ 金額は概算です。最終報酬額は個別契約・業務範囲・繁忙度・データ品質等により調整します。</div>
        </div>
      </div>
    </div>
  </section>
</div>

<footer class="mk-mini noprint">
  <div class="inner">
    © <span id="cpy-year"></span> <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener">税理士法人松本会計事務所</a> ｜
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ja" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> ｜
    <a href="#" onclick="alert('本ツールは概算見積の補助を目的としています。最終報酬額は個別契約・業務範囲・繁忙度・データ品質等により調整します。');return false;">利用条件</a> ｜
    <span id="rev"></span>
  </div>
</footer>

<script>
const APP_VER='r4.5';
const TAX=0.10;
const el = (id)=>document.getElementById(id);
const fmt=(n)=> (isNaN(n)?0:n).toLocaleString('ja-JP');
const yen=(n)=>'¥'+fmt(Math.round(n||0));

let ent = localStorage.getItem('mk_ent')||'corp';
let adjust = {memo:'', amt:0};

const bandsCorp=[
  {min:0, max:5000000, fee:35000},
  {min:5000000, max:10000000, fee:37000},
  {min:10000000, max:20000000, fee:39000},
  {min:20000000, max:30000000, fee:41000},
  {min:30000000, max:50000000, fee:45000},
  {min:50000000, max:70000000, fee:49000},
  {min:70000000, max:100000000, fee:55000},
  {min:100000000, max:200000000, fee:73000},
  {min:200000000, max:300000000, fee:89000},
  {min:300000000, max:500000000, fee:105000},
  {min:500000000, max:700000000, fee:119000},
  {min:700000000, max:1000000000, fee:125000},
  {min:1000000000, max:2000000000, fee:143000},
  {min:2000000000, max:3000000000, fee:170000},
  {min:3000000000, max:5000000000, fee:215000},
  {min:5000000000, max:10000000000, fee:260000},
  {min:10000000000, max:Infinity, fee:null}
];
const bandsSole=[
  {min:0, max:5000000, fee:27000},
  {min:5000000, max:10000000, fee:29000},
  {min:10000000, max:20000000, fee:31000},
  {min:20000000, max:30000000, fee:33000},
  {min:30000000, max:50000000, fee:37000},
  {min:50000000, max:70000000, fee:41000},
  {min:70000000, max:100000000, fee:47000},
  {min:100000000, max:Infinity, fee:null}
];

const servicesMaster=[
  {ent:'both',cat:"月次顧問", name:"月次顧問料（付加価値ベース）", unit:"月額", kind:"fixed", price:0, qty:1, allowQty:false, note:"付加価値帯から自動設定"},
  {ent:'corp',cat:"決算・申告（法人）", name:"法人決算・申告一式", unit:"スポット", kind:"mult_m", months:4, price:0, qty:0, allowQty:false, note:"月次顧問報酬の4ヶ月分"},
  {ent:'corp',cat:"決算・申告（法人）", name:"消費税申告書作成", unit:"スポット", kind:"mult_m", months:2, price:0, qty:0, allowQty:false, note:"月次顧問報酬の2ヶ月分"},
  {ent:'both',cat:"年末調整", name:"年末調整 基本料金", unit:"スポット", kind:"fixed", price:20000, qty:0, allowQty:false, note:"法定調書合計表含む"},
  {ent:'both',cat:"年末調整", name:"年末調整 人数（1人目から）", unit:"スポット", kind:"per_qty", price:3000, qty:0, allowQty:true, note:"×人数"},
  {ent:'both',cat:"償却資産税申告", name:"償却資産税申告（市町村・件数）", unit:"スポット", kind:"asset_tax", base:10000, extra:3000, qty:0, allowQty:true, note:"基本10,000円＋（件数-1）×3,000円"},
  {ent:'both',cat:"ソフトウェアレンタル", name:"FX4クラウド", unit:"月額", kind:"fixed", price:60000, qty:0, allowQty:false, editablePrice:true},
  {ent:'both',cat:"ソフトウェアレンタル", name:"FX2クラウド", unit:"月額", kind:"fixed", price:15000, qty:0, allowQty:false, editablePrice:true},
  {ent:'both',cat:"ソフトウェアレンタル", name:"FXまいスタークラウド", unit:"月額", kind:"fixed", price:12000, qty:0, allowQty:false, editablePrice:true},
  {ent:'both',cat:"ソフトウェアレンタル", name:"（その他）", unit:"月額", kind:"group_other", price:0, qty:0, allowQty:false, note:"クリックで展開"},
  {ent:'both',cat:"ソフトウェアレンタル", name:"PX4クラウド", unit:"月額", kind:"fixed", price:0, qty:0, allowQty:false, editablePrice:true, swOther:true}
];
let services=[];
function resetServices(){ services = servicesMaster.filter(s=>s.ent==='both'||s.ent===ent).map(s=>({...s})); }

/* 数値入力のカンマフォーマッタ */
function parseNum(str, allowNegative=false){
  const s=(String(str||'')).replace(/,/g,'').trim();
  const n = allowNegative ? parseFloat(s.replace(/[^0-9.-]/g,'')) : parseFloat(s.replace(/[^0-9.]/g,''));
  return isNaN(n)?0:n;
}
function bindCommaInput(input, allowNegative=false){
  const fmtIt=()=>{ const n=parseNum(input.value, allowNegative); input.value = fmt(n); if(input.dataset.role==='vadd') recalc(); };
  input.addEventListener('input', fmtIt);
  input.addEventListener('blur', fmtIt);
}

function setEnt(v){ ent=v; localStorage.setItem('mk_ent',ent); updateEntUI(); renderBands(); recalc(); }
window.setEnt=setEnt;

function updateEntUI(){
  document.getElementById('ent-corp').classList.toggle('active', ent==='corp');
  document.getElementById('ent-sole').classList.toggle('active', ent==='sole');
  el('ent-label').textContent=ent==='corp'?'法人':'個人';
  el('ent-label2').textContent=ent==='corp'?'法人':'個人';
}

function renderBands(){
  const tbody = document.querySelector('#bands tbody'); tbody.innerHTML='';
  (ent==='corp'?bandsCorp:bandsSole).forEach(x=>{
    const tr=document.createElement('tr');
    const label = x.max===Infinity? `${fmt(x.min)}円超` : `${fmt(x.min)}〜${fmt(x.max)}円`;
    tr.innerHTML = `<td>${label}</td><td style="text-align:right">${x.fee?yen(x.fee):'別途お見積り'}</td>`;
    tbody.appendChild(tr);
  });
}

function getVal(id){ return parseNum(el(id).value); }
function calcVadd(){
  if(ent==='corp'){
    return Math.max(0, getVal('c_ordinary')+getVal('c_labor')+getVal('c_int')+getVal('c_rent')+getVal('c_lease')+getVal('c_tax')+getVal('c_dep'));
  }else{
    return Math.max(0, getVal('s_preprofit')+getVal('s_family')+getVal('s_labor')+getVal('s_int')+getVal('s_rent')+getVal('s_lease')+getVal('s_tax')+getVal('s_dep')+3000000);
  }
}
function bandFee(v){ const arr=ent==='corp'?bandsCorp:bandsSole; for(const x of arr){ if(v>=x.min && v<x.max) return x.fee; } return null; }

function recalc(){
  const corp=ent==='corp';
  el('calc-corp').style.display=corp?'block':'none';
  el('calc-sole').style.display=corp?'none':'block';
  const v=calcVadd(); el('vadd').textContent=fmt(v);
  const fee=bandFee(v)||0; el('monthly').textContent=yen(fee);
  const arr = ent==='corp'?bandsCorp:bandsSole; const band=arr.find(x=>v>=x.min&&v<x.max);
  el('band').textContent = band ? (band.max===Infinity?`${fmt(band.min)}円超`:`${fmt(band.min)}〜${fmt(band.max)}円`) : '—';
  if(services.length && services[0].cat==='月次顧問') services[0].price=fee;
  renderServices();
  renderQuote();
}

function loadServices(){ resetServices(); }

function renderServices(){
  const host=el('services'); host.innerHTML='';
  const orderCorp=["月次顧問","ソフトウェアレンタル","決算・申告（法人）","年末調整","償却資産税申告"]; const orderSole=["月次顧問","ソフトウェアレンタル","個人確定申告","年末調整","償却資産税申告"];
  const order=ent==='corp'?orderCorp:orderSole;
  const cats=[...new Set(services.map(x=>x.cat))].sort((a,b)=>order.indexOf(a)-order.indexOf(b));
  cats.forEach(c=>{
    const items=services.filter(x=>x.cat===c);
    const box=document.createElement('div'); box.className='card'; box.style.marginBottom='.6rem';
    box.innerHTML=`<div class="hd"><strong>${c}</strong><span class="mini">${items.length}項目</span></div>`;
    const bd=document.createElement('div'); bd.className='bd';

    if(c==='ソフトウェアレンタル'){
      const prim=items.filter(x=>!x.swOther && x.kind!=='group_other');
      const others=items.filter(x=>x.swOther);
      const orderNames=['FX4クラウド','FX2クラウド','FXまいスタークラウド'];
      prim.sort((a,b)=>orderNames.indexOf(a.name)-orderNames.indexOf(b.name));
      prim.forEach(it=>bd.appendChild(renderServiceRow(it)));
      const grp=items.find(x=>x.kind==='group_other');
      if(grp){
        const det=document.createElement('details'); det.className='details';
        det.innerHTML=`<summary class="pill"><span class="caret">▶</span> その他（クリックで展開）</summary>`;
        const inner=document.createElement('div'); inner.style.marginTop='.5rem';
        others.forEach(it=> inner.appendChild(renderServiceRow(it)));
        const addBox=document.createElement('div'); addBox.className='wrap'; addBox.style.marginTop='.5rem';
        addBox.innerHTML=`<input id="custom-soft-name" type="text" placeholder="ソフト名" style="max-width:220px">
          <input id="custom-soft-price" type="text" inputmode="numeric" data-commas placeholder="月額単価" style="max-width:150px">
          <button class="btn sm" type="button" onclick="addCustomSoft()">追加</button>`;
        inner.appendChild(addBox); det.appendChild(inner); bd.appendChild(det);
      }
      box.appendChild(bd); host.appendChild(box); return;
    }

    items.forEach(it=> bd.appendChild(renderServiceRow(it)));
    box.appendChild(bd); host.appendChild(box);
  });
  document.querySelectorAll('#services input[data-commas]').forEach(inp=>bindCommaInput(inp,false));
}

function renderServiceRow(it){
  const idx=services.indexOf(it); const id=`svc_${it.cat}_${idx}`;
  const row=document.createElement('div'); row.className='wrap'; row.style.justifyContent='space-between';
  const left=document.createElement('div'); left.style.flex='1';
  left.innerHTML=`<label for="${id}" style="display:block">${it.name} <span class="mini">(${it.unit})</span></label><div class="mini">${it.note||''}</div>`;
  const right=document.createElement('div'); right.className='wrap';
  let priceCtrl = `<span class="pill">単価 <b>${it.kind==='mult_m' ? '＝月次×'+it.months : yen(it.price)}</b></span>`;
  if(it.kind==='asset_tax') priceCtrl=`<span class="pill">単価 <b>${yen(it.base)}＋${yen(it.extra)}×(件数-1)</b></span>`;
  if(it.editablePrice){ priceCtrl=`<span class="pill">単価 <input type="text" inputmode="numeric" data-commas value="${fmt(it.price||0)}" style="width:120px" oninput="setPrice(${idx}, this.value)"></span>`; }
  right.innerHTML=`${it.allowQty?`<input id="${id}_qty" type="text" inputmode="numeric" data-commas value="${fmt(it.qty||0)}" style="width:110px" oninput="setQty(${idx}, this.value)">`:`<span class="pill">${it.qty>0?'選択中':'数量固定'}</span>`}
    ${priceCtrl}
    ${it.kind!=='group_other'?`<input id="${id}" type="checkbox" ${it.qty>0?'checked':''} onchange="toggle(${idx}, this.checked)">`:''}`;
  row.appendChild(left); row.appendChild(right); return row;
}

function toggle(i,on){ const it=services[i]; if(it.allowQty){ it.qty=on?(it.qty||1):0; } else{ it.qty=on?1:0; } renderQuote(); }
function setQty(i,v){ services[i].qty=Math.max(0,parseNum(v)); renderQuote(); }
function setPrice(i,v){ services[i].price=Math.max(0,parseNum(v)); renderQuote(); }

function buildQuoteRows(){
  const rows=[]; let m=0,o=0; const noteList=[];
  services.forEach(it=>{
    const q=+it.qty||0; if(!q || it.kind==='group_other') return;
    let monthUnit=''; let yearSub=0;
    if(it.kind==='mult_m'){
      const u=(services[0].price||0)*it.months; monthUnit=''; yearSub=u*q;
      // 備考例：消費税は月次×2ヶ月 等は行名に含むため備考不要
    }else if(it.kind==='per_qty'){
      monthUnit=''; yearSub=(it.price||0)*q; // 1人あたり
    }else if(it.kind==='asset_tax'){
      monthUnit=''; yearSub = q>=1 ? (it.base + Math.max(0,q-1)*it.extra) : 0;
    }else{ // fixed 月額
      monthUnit = yen(it.price||0);
      yearSub = (it.price||0) * 12 * q;
    }
    rows.push({name:it.name, qty:q, monthUnit, yearSub, unit:it.unit});
    if(it.unit==='月額') m+=yearSub; else o+=yearSub;
  });
  return {rows, m, o, noteList};
}

function renderQuote(){
  const qtbody=el('q-tbody'); qtbody.innerHTML='';
  const {rows,m,o} = buildQuoteRows();
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.name}</td><td>${fmt(r.qty)}</td><td>${r.monthUnit||''}</td><td>${yen(r.yearSub)}</td>`; qtbody.appendChild(tr);
  });
  const yTotal = m; // m already is 年間（月額×12×数量）の合計として扱っている
  const base = yTotal + o + (adjust.amt||0);
  const tax = Math.round(base*TAX);
  const total = base + tax;

  // 合計ボックス
  el('grand-tax-in').textContent = yen(total) + '（税込）';

  // 下部ラベル群（小計・調整・税・合計）
  const box=el('q-totals'); box.innerHTML='';
  const row = (name,val,cls='')=>{ const div=document.createElement('div'); div.className='row '+cls; div.innerHTML=`<div class="name">${name}</div><div>${yen(val)}</div>`; return div; };
  box.appendChild(row('小計', yTotal+o));
  // 調整（スポットと消費税の間）
  const adjName = '調整（±）' + (adjust.memo? `：${adjust.memo}`:'');
  box.appendChild(row(adjName, adjust.amt||0));
  box.appendChild(row('消費税 10%', tax));
  box.appendChild(row('合計金額', total, 'total'));

  // 備考（年末調整など注釈が必要ならここで拡張可）
  const ul=el('q-notes-list'); ul.innerHTML='';
}

/* 画面切替 */
function showQuoteView(){ document.getElementById('view-input').classList.remove('active'); document.getElementById('view-quote').classList.add('active'); el('btn-go-quote').style.display='none'; el('btn-back-input').style.display='inline-flex'; }
function showInputView(){ document.getElementById('view-quote').classList.remove('active'); document.getElementById('view-input').classList.add('active'); el('btn-back-input').style.display='none'; el('btn-go-quote').style.display='inline-flex'; }

/* 初期化 */
(function init(){
  const d=new Date(document.lastModified); el('cpy-year').textContent=String(new Date().getFullYear()); el('rev').textContent=APP_VER+'（'+d.toISOString().slice(0,10)+'）';
  // 事件
  document.getElementById('ent-corp').addEventListener('click',()=>setEnt('corp'));
  document.getElementById('ent-sole').addEventListener('click',()=>setEnt('sole'));
  document.getElementById('tab-v').addEventListener('click',()=>{ el('pane-v').style.display='block'; el('pane-s').style.display='none'; });
  document.getElementById('tab-s').addEventListener('click',()=>{ el('pane-v').style.display='none'; el('pane-s').style.display='block'; });
  document.getElementById('btn-show-quote').addEventListener('click',()=>{ // サービス画面のボタン
    el('to-line').textContent = (el('adj-memo').value||'').trim() ? `${el('adj-memo').value.trim()} 御中` : '（宛名未入力） 御中';
    showQuoteView(); window.scrollTo({top:0,behavior:'smooth'});
  });
  document.getElementById('btn-go-quote').addEventListener('click',()=>{ showQuoteView(); window.scrollTo({top:0,behavior:'smooth'}); });
  document.getElementById('btn-back-input').addEventListener('click',()=>{ showInputView(); });

  // 調整
  bindCommaInput(el('adj-amt'), true);
  el('adj-memo').addEventListener('input', e=>{ adjust.memo=e.target.value||''; renderQuote(); });
  el('adj-amt').addEventListener('input', e=>{ adjust.amt=parseNum(e.target.value,true)||0; renderQuote(); });

  // 宛名入力（見積ビューで編集可能に）
  const toEdit=document.createElement('input'); toEdit.type='text'; toEdit.placeholder='宛名（例：株式会社〇〇）'; toEdit.style.width='320px'; toEdit.addEventListener('input',()=>{ el('to-line').textContent = (toEdit.value||'').trim()? `${toEdit.value.trim()} 御中`:'（宛名未入力） 御中';});
  // 便宜上、入力ビューの末尾に表示
  document.querySelector('#view-input .bd#pane-s').appendChild((()=>{ const w=document.createElement('div'); w.style.margin='10px 0'; w.className='mini'; w.innerHTML='<span>※ 宛名は御見積書ビューで直接編集できます</span>'; return w; })());

  // 付加価値入力フォーマッタ
  document.querySelectorAll('input[data-role="vadd"]').forEach(inp=>bindCommaInput(inp,false));

  updateEntUI(); loadServices(); renderBands(); recalc();

  // デフォルト日付
  el('doc-date').value = (new Date()).toISOString().slice(0,10);
})();
</script>
</body>
</html>
